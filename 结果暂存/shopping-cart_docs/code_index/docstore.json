{"docstore/metadata": {"b2605c63-2361-4db8-99e1-d0a5f0526b14": {"doc_hash": "a61d14a535d2b3f4237abd58ec8cb19d2814dcbbed86e8bb1265ede73b56e709"}, "58d0341e-ba90-47ec-8994-f7961dbe9118": {"doc_hash": "195d6dfb612a1f904c17703bea08c767a6b9c0b557a507257815cc459670486a"}, "c3135f56-ce94-468c-94f9-97128b11f7b6": {"doc_hash": "de616e9363ecd7bc27c79488829d644f86bf18b635167277b17ab9d498f0136e"}, "928d59ff-4411-421a-b861-1616c662a020": {"doc_hash": "963d3d987bb4885fefbd08014bd4ca2e034f0752c20f400ddde0110d33645421"}, "67176075-a0f3-442c-ad0d-66efe795fb45": {"doc_hash": "2f46d6dedc97cac86dc13e77e4e68e0a5ff345b53d9201b4fe5265aeb29d4665"}, "572c1987-a7ac-4231-a539-34661fb41e8b": {"doc_hash": "ad2fac187d956b205a2c31f55e7f2d90bdea6a00acddc488bb08f703b2d85337"}, "b05df6de-cc68-427b-be79-3690b17c8114": {"doc_hash": "e5197f0fff69a023c441797da9570aab67f686daaa25db6343e5821a39ff36fe", "ref_doc_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14"}, "8034354d-40f1-4391-9c7c-6c8f5cb1c29d": {"doc_hash": "e454d9a5bfe41e475388a6e5de022b49db5aaf4caf7769ced5cefe18f4a817fa", "ref_doc_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14"}, "f896041d-0b3c-47fc-b603-529d277d2d10": {"doc_hash": "1be92eb48999f16342d7de46a5ec08f1ee8f7358f616e6f20a388559acfbbffa", "ref_doc_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14"}, "792feee5-ec29-461c-86fc-444dd3d193e4": {"doc_hash": "5d670804f8a2a1a4118b45b4b0711bbe0d34f4682fa826eadc1c5aaf72be3421", "ref_doc_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14"}, "31011200-baf0-4b72-b425-db78783cd938": {"doc_hash": "b0f2e52e6dd9db9222788cd10804ca5cfba94a03f39e8b121051170535ead229", "ref_doc_id": "58d0341e-ba90-47ec-8994-f7961dbe9118"}, "1f82accb-09fd-405b-84c3-1c89768c4da0": {"doc_hash": "860ab4d75829079d1c15fb581adab0eb01d895f80eb180c636036930d08fa1e5", "ref_doc_id": "c3135f56-ce94-468c-94f9-97128b11f7b6"}, "97c9bca3-caee-48fa-9476-47547f90dae3": {"doc_hash": "5404089ac7472980e9a62b9a8c96e7a12fb91f82a7862eb0fb94d8d99a54a8bd", "ref_doc_id": "928d59ff-4411-421a-b861-1616c662a020"}, "1814ade2-b440-4637-85ac-6ac3cb4c6a7f": {"doc_hash": "f95345da9965a62fd4877089bc90085da9b36604ed7ead87fd1d6850d114e3df", "ref_doc_id": "928d59ff-4411-421a-b861-1616c662a020"}, "a4729e92-cc77-460a-9ef9-bc01b34413f6": {"doc_hash": "c91667d074c04097fe46bb6cc75928b7bb479db97fc4a41210d17ded3e8a3363", "ref_doc_id": "67176075-a0f3-442c-ad0d-66efe795fb45"}, "3163b999-8fa3-472d-a062-3f4d94af1d66": {"doc_hash": "0e0db2d13a48bf0c29473dad2867a1f5f5ea0df6529d45c1e3f814b459732552", "ref_doc_id": "572c1987-a7ac-4231-a539-34661fb41e8b"}, "e2422553-aca1-4c73-bcdd-4a8ca2abd5e3": {"doc_hash": "ffac5565e2dd115c40bdcea484d7156f91e2ad4839ec45eea37b80370222d7fd", "ref_doc_id": "572c1987-a7ac-4231-a539-34661fb41e8b"}, "33f34b8e-968c-463d-a085-4b3a977ccb89": {"doc_hash": "ca57297caf28837ff80f11f508c7514b0b0585e7530242de97c1c5ea00eb5795", "ref_doc_id": "572c1987-a7ac-4231-a539-34661fb41e8b"}, "c18b2d1a-f010-4954-94d9-dabb551080c1": {"doc_hash": "e0a67ccb7b3b15ecc7af65641e07349e59618acc728ef2c922d496d3ba9c7eb9", "ref_doc_id": "572c1987-a7ac-4231-a539-34661fb41e8b"}, "c1a7f510-bc4b-4cc1-ad24-7af82d503be3": {"doc_hash": "e4063b1162fe150d62887b272a68c0c56d1eebffaeb167acef0b948a40afc323", "ref_doc_id": "572c1987-a7ac-4231-a539-34661fb41e8b"}}, "docstore/ref_doc_info": {"b2605c63-2361-4db8-99e1-d0a5f0526b14": {"node_ids": ["b05df6de-cc68-427b-be79-3690b17c8114", "8034354d-40f1-4391-9c7c-6c8f5cb1c29d", "f896041d-0b3c-47fc-b603-529d277d2d10", "792feee5-ec29-461c-86fc-444dd3d193e4"], "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}}, "58d0341e-ba90-47ec-8994-f7961dbe9118": {"node_ids": ["31011200-baf0-4b72-b425-db78783cd938"], "metadata": {"file_path": "auth.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 87}}, "c3135f56-ce94-468c-94f9-97128b11f7b6": {"node_ids": ["1f82accb-09fd-405b-84c3-1c89768c4da0"], "metadata": {"file_path": "db.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 47}}, "928d59ff-4411-421a-b861-1616c662a020": {"node_ids": ["97c9bca3-caee-48fa-9476-47547f90dae3", "1814ade2-b440-4637-85ac-6ac3cb4c6a7f"], "metadata": {"file_path": "init_dynamodb.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 141}}, "67176075-a0f3-442c-ad0d-66efe795fb45": {"node_ids": ["a4729e92-cc77-460a-9ef9-bc01b34413f6"], "metadata": {"file_path": "load_products.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 70}}, "572c1987-a7ac-4231-a539-34661fb41e8b": {"node_ids": ["3163b999-8fa3-472d-a062-3f4d94af1d66", "e2422553-aca1-4c73-bcdd-4a8ca2abd5e3", "33f34b8e-968c-463d-a085-4b3a977ccb89", "c18b2d1a-f010-4954-94d9-dabb551080c1", "c1a7f510-bc4b-4cc1-ad24-7af82d503be3"], "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}}}, "docstore/data": {"b05df6de-cc68-427b-be79-3690b17c8114": {"__data__": {"id_": "b05df6de-cc68-427b-be79-3690b17c8114", "embedding": null, "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14", "node_type": "4", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "a61d14a535d2b3f4237abd58ec8cb19d2814dcbbed86e8bb1265ede73b56e709", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8034354d-40f1-4391-9c7c-6c8f5cb1c29d", "node_type": "1", "metadata": {}, "hash": "b0e618b2b1b0afba597dd7466a1d333e0271020df6ba7a00808bd96e8b218c6d", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "\"\"\"\n\u8d2d\u7269\u8f66\u5355\u4f53\u5e94\u7528 - \u4e3b\u5e94\u7528\u6587\u4ef6\n\u63d0\u4f9b\u4ea7\u54c1\u67e5\u8be2\u548c\u8d2d\u7269\u8f66\u7ba1\u7406\u7684RESTful API\n\"\"\"\nimport json\nimport os\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom uuid import uuid4\n\nfrom flask import Flask, request, jsonify, make_response, send_from_directory\nfrom flask_cors import CORS\n\nfrom db import close_connection\nfrom init_dynamodb import init_dynamodb\nfrom auth import create_token, verify_token, hash_password, verify_password\nfrom models import (\n    get_cart_items,\n    add_cart_item,\n    update_cart_item_quantity,\n    delete_cart_items,\n    get_product_total_quantity,\n    update_product_total_quantity,\n    migrate_cart_items,\n    create_user,\n    get_user_by_username\n)\n\n# \u521d\u59cb\u5316Flask\u5e94\u7528\napp = Flask(__name__)\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-secret-key-change-in-production')\nCORS(app, supports_credentials=True)\n\n# \u52a0\u8f7d\u4ea7\u54c1\u6570\u636e\nimport os as _os\n_current_dir = _os.path.dirname(_os.path.abspath(__file__))\n_product_file = _os.path.join(_current_dir, 'product_list.json')\nwith open(_product_file, 'r', encoding='utf-8') as f:\n    PRODUCT_LIST = json.load(f)\n\n# \u521d\u59cb\u5316DynamoDB\u6570\u636e\u5e93\nwith app.app_context():\n    init_dynamodb()\n\n# \u6ce8\u518cteardown\u51fd\u6570\uff0c\u7528\u4e8e\u6e05\u7406\u8fde\u63a5\napp.teardown_appcontext(close_connection)\n\n\ndef get_cart_id_from_cookie():\n    \"\"\"\u4eceCookie\u4e2d\u83b7\u53d6\u8d2d\u7269\u8f66ID\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5219\u751f\u6210\u65b0\u7684\"\"\"\n    cart_id = request.cookies.get('cartId')\n    generated = False\n    if not cart_id:\n        cart_id = str(uuid4())\n        generated = True\n    return cart_id, generated\n\n\ndef set_cart_cookie(response, cart_id):\n    \"\"\"\u8bbe\u7f6e\u8d2d\u7269\u8f66Cookie\"\"\"\n    response.set_cookie(\n        'cartId',\n        cart_id,\n        max_age=60 * 60 * 24,  # 1\u5929\n        secure=False,  # \u5f00\u53d1\u73af\u5883\u8bbe\u4e3aFalse\uff0c\u751f\u4ea7\u73af\u5883\u5e94\u4e3aTrue\n        httponly=True,\n        samesite='Lax',\n        path='/'\n    )\n    return response\n\n\ndef login_required(f):\n    \"\"\"\u8ba4\u8bc1\u88c5\u9970\u5668 - \u8981\u6c42\u7528\u6237\u767b\u5f55\"\"\"\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        auth_header = request.headers.get('Authorization')\n        if not auth_header:\n            return jsonify({'message': 'Missing authorization header'}), 401\n        \n        try:\n            # \u652f\u6301 \"Bearer token\" \u6216\u76f4\u63a5 \"token\" \u683c\u5f0f\n            token = auth_header.replace('Bearer ', '')\n            payload = verify_token(token)\n            request.user_id = payload['sub']\n            request.username = payload['username']\n        except Exception as e:\n            return jsonify({'message': 'Invalid or expired token'}), 401\n        \n        return f(*args, **kwargs)\n    \n    return decorated_function\n\n\ndef get_user_identifier():\n    \"\"\"\u83b7\u53d6\u7528\u6237\u6807\u8bc6\uff08\u5df2\u767b\u5f55\u7528\u6237\u7684user_id\u6216\u533f\u540d\u7528\u6237\u7684cart_id\uff09\"\"\"\n    auth_header = request.headers.get('Authorization')\n    if auth_header:\n        try:\n            token = auth_header.replace('Bearer ', '')\n            payload = verify_token(token)\n            return f\"user#{payload['sub']}\", True\n        except:\n            pass\n    \n    cart_id, _ = get_cart_id_from_cookie()\n    return f\"cart#{cart_id}\", False\n\n\n# ==================== \u7528\u6237\u8ba4\u8bc1\u76f8\u5173API ====================\n\n@app.route('/auth/register', methods=['POST'])\ndef register():\n    \"\"\"\u7528\u6237\u6ce8\u518c\"\"\"\n    data = request.get_json()\n    username = data.get('username')\n    password = data.get('password')\n    email = data.get('email')\n    \n    if not username or not password:\n        return jsonify({'message': 'Username and password required'}), 400\n    \n    # \u68c0\u67e5\u7528\u6237\u662f\u5426\u5df2\u5b58\u5728\n    if get_user_by_username(username):\n        return jsonify({'message': 'Username already exists'}), 400\n    \n    # \u521b\u5efa\u7528\u6237\n    user_id = create_user(username, password, email)\n    \n    return jsonify({\n        'message': 'User registered successfully',\n        'userId': user_id\n    }), 201", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3579, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "8034354d-40f1-4391-9c7c-6c8f5cb1c29d": {"__data__": {"id_": "8034354d-40f1-4391-9c7c-6c8f5cb1c29d", "embedding": null, "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14", "node_type": "4", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "a61d14a535d2b3f4237abd58ec8cb19d2814dcbbed86e8bb1265ede73b56e709", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b05df6de-cc68-427b-be79-3690b17c8114", "node_type": "1", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "e5197f0fff69a023c441797da9570aab67f686daaa25db6343e5821a39ff36fe", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f896041d-0b3c-47fc-b603-529d277d2d10", "node_type": "1", "metadata": {}, "hash": "b3c4fb15cd7b99a62e457b9de1e08999124f8c0632e7057836bd95d94098f9a0", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "# ==================== \u7528\u6237\u8ba4\u8bc1\u76f8\u5173API ====================\n\n@app.route('/auth/register', methods=['POST'])\ndef register():\n    \"\"\"\u7528\u6237\u6ce8\u518c\"\"\"\n    data = request.get_json()\n    username = data.get('username')\n    password = data.get('password')\n    email = data.get('email')\n    \n    if not username or not password:\n        return jsonify({'message': 'Username and password required'}), 400\n    \n    # \u68c0\u67e5\u7528\u6237\u662f\u5426\u5df2\u5b58\u5728\n    if get_user_by_username(username):\n        return jsonify({'message': 'Username already exists'}), 400\n    \n    # \u521b\u5efa\u7528\u6237\n    user_id = create_user(username, password, email)\n    \n    return jsonify({\n        'message': 'User registered successfully',\n        'userId': user_id\n    }), 201\n\n\n@app.route('/auth/login', methods=['POST'])\ndef login():\n    \"\"\"\u7528\u6237\u767b\u5f55\"\"\"\n    data = request.get_json()\n    username = data.get('username')\n    password = data.get('password')\n    \n    if not username or not password:\n        return jsonify({'message': 'Username and password required'}), 400\n    \n    # \u9a8c\u8bc1\u7528\u6237\n    user = get_user_by_username(username)\n    if not user or not verify_password(password, user['password_hash']):\n        return jsonify({'message': 'Invalid credentials'}), 401\n    \n    # \u751f\u6210JWT token\n    token = create_token(user['id'], username)\n    \n    return jsonify({\n        'message': 'Login successful',\n        'token': token,\n        'userId': user['id'],\n        'username': username\n    }), 200\n\n\n# ==================== \u4ea7\u54c1\u76f8\u5173API ====================\n\n@app.route('/product', methods=['GET'])\ndef get_products():\n    \"\"\"\u83b7\u53d6\u6240\u6709\u4ea7\u54c1\u5217\u8868\"\"\"\n    return jsonify({'products': PRODUCT_LIST}), 200\n\n\n@app.route('/product/<product_id>', methods=['GET'])\ndef get_product(product_id):\n    \"\"\"\u83b7\u53d6\u5355\u4e2a\u4ea7\u54c1\u8be6\u60c5\"\"\"\n    product = next((p for p in PRODUCT_LIST if p['productId'] == product_id), None)\n    \n    if not product:\n        return jsonify({'message': 'Product not found'}), 404\n    \n    return jsonify({'product': product}), 200\n\n\n# ==================== \u8d2d\u7269\u8f66\u76f8\u5173API ====================\n\n@app.route('/cart', methods=['GET'])\ndef list_cart():\n    \"\"\"\u83b7\u53d6\u5f53\u524d\u7528\u6237\u7684\u8d2d\u7269\u8f66\u5185\u5bb9\"\"\"\n    cart_id, generated = get_cart_id_from_cookie()\n    pk, is_authenticated = get_user_identifier()\n    \n    # \u5982\u679c\u662f\u65b0\u751f\u6210\u7684cart_id\uff0c\u4e0d\u9700\u8981\u67e5\u8be2\u6570\u636e\u5e93\n    if generated and not is_authenticated:\n        product_list = []\n    else:\n        product_list = get_cart_items(pk)\n    \n    # \u6e05\u7406\u8fd4\u56de\u6570\u636e\u683c\u5f0f\n    for product in product_list:\n        if 'sk' in product:\n            product['sk'] = product['sk'].replace('product#', '')\n    \n    response = make_response(jsonify({'products': product_list}))\n    response = set_cart_cookie(response, cart_id)\n    return response, 200\n\n\n@app.route('/cart', methods=['POST'])\ndef add_to_cart():\n    \"\"\"\u6dfb\u52a0\u5546\u54c1\u5230\u8d2d\u7269\u8f66\"\"\"\n    data = request.get_json()\n    if not data:\n        return jsonify({'message': 'No request payload'}), 400\n    \n    product_id = data.get('productId')\n    quantity = data.get('quantity', 1)\n    \n    if not product_id:\n        return jsonify({'message': 'Product ID required'}), 400\n    \n    # \u9a8c\u8bc1\u4ea7\u54c1\u662f\u5426\u5b58\u5728\n    product = next((p for p in PRODUCT_LIST if p['productId'] == product_id), None)\n    if not product:\n        return jsonify({'message': 'Product not found'}), 404\n    \n    cart_id, _ = get_cart_id_from_cookie()\n    pk, is_authenticated = get_user_identifier()\n    \n    # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\n    if is_authenticated:\n        ttl = datetime.now() + timedelta(days=7)\n    else:\n        ttl = datetime.now() + timedelta(days=1)\n    \n    # \u6dfb\u52a0\u6216\u66f4\u65b0\u8d2d\u7269\u8f66\u9879\n    try:\n        add_cart_item(pk, product_id, quantity, product, ttl)\n        # \u540c\u6b65\u66f4\u65b0\u5546\u54c1\u7edf\u8ba1\n        update_product_total_quantity(product_id, quantity)\n    except Exception as e:\n        return jsonify({'message': f'Failed to add to cart: {str(e)}'}), 500\n    \n    response = make_response(jsonify({\n        'productId': product_id,\n        'message': 'product added to cart'\n    }))\n    response = set_cart_cookie(response, cart_id)\n    return response, 200", "mimetype": "text/plain", "start_char_idx": 2886, "end_char_idx": 6765, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "f896041d-0b3c-47fc-b603-529d277d2d10": {"__data__": {"id_": "f896041d-0b3c-47fc-b603-529d277d2d10", "embedding": null, "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14", "node_type": "4", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "a61d14a535d2b3f4237abd58ec8cb19d2814dcbbed86e8bb1265ede73b56e709", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8034354d-40f1-4391-9c7c-6c8f5cb1c29d", "node_type": "1", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "e454d9a5bfe41e475388a6e5de022b49db5aaf4caf7769ced5cefe18f4a817fa", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "792feee5-ec29-461c-86fc-444dd3d193e4", "node_type": "1", "metadata": {}, "hash": "a773a584863abec83043dfb81da04ab5509275122d1c5a96383eee182f99656e", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "@app.route('/cart/<product_id>', methods=['PUT'])\ndef update_cart(product_id):\n    \"\"\"\u66f4\u65b0\u8d2d\u7269\u8f66\u4e2d\u6307\u5b9a\u5546\u54c1\u7684\u6570\u91cf\uff08\u5e42\u7b49\u64cd\u4f5c\uff09\"\"\"\n    data = request.get_json()\n    if not data:\n        return jsonify({'message': 'No request payload'}), 400\n    \n    quantity = int(data.get('quantity', 0))\n    \n    if quantity < 0:\n        return jsonify({\n            'productId': product_id,\n            'message': 'Quantity must not be lower than 0'\n        }), 400\n    \n    # \u9a8c\u8bc1\u4ea7\u54c1\u662f\u5426\u5b58\u5728\n    product = next((p for p in PRODUCT_LIST if p['productId'] == product_id), None)\n    if not product:\n        return jsonify({'message': 'Product not found'}), 404\n    \n    cart_id, _ = get_cart_id_from_cookie()\n    pk, is_authenticated = get_user_identifier()\n    \n    # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\n    if is_authenticated:\n        ttl = datetime.now() + timedelta(days=7)\n    else:\n        ttl = datetime.now() + timedelta(days=1)\n    \n    try:\n        # \u83b7\u53d6\u65e7\u7684\u6570\u91cf\u4ee5\u8ba1\u7b97\u5dee\u503c\n        old_quantity = 0\n        items = get_cart_items(pk)\n        for item in items:\n            if item['sk'] == f\"product#{product_id}\":\n                old_quantity = item['quantity']\n                break\n        \n        # \u66f4\u65b0\u8d2d\u7269\u8f66\u9879\n        update_cart_item_quantity(pk, product_id, quantity, product, ttl)\n        \n        # \u540c\u6b65\u66f4\u65b0\u5546\u54c1\u7edf\u8ba1\uff08\u5dee\u503c\uff09\n        quantity_diff = quantity - old_quantity\n        if quantity_diff != 0:\n            update_product_total_quantity(product_id, quantity_diff)\n    except Exception as e:\n        return jsonify({'message': f'Failed to update cart: {str(e)}'}), 500\n    \n    response = make_response(jsonify({\n        'productId': product_id,\n        'quantity': quantity,\n        'message': 'cart updated'\n    }))\n    response = set_cart_cookie(response, cart_id)\n    return response, 200\n\n\n@app.route('/cart/migrate', methods=['POST'])\n@login_required\ndef migrate_cart():\n    \"\"\"\u5c06\u533f\u540d\u8d2d\u7269\u8f66\u8fc1\u79fb\u5230\u5df2\u767b\u5f55\u7528\u6237\u8d26\u6237\"\"\"\n    cart_id, _ = get_cart_id_from_cookie()\n    user_id = request.user_id\n    \n    anonymous_pk = f\"cart#{cart_id}\"\n    user_pk = f\"user#{user_id}\"\n    \n    try:\n        # \u8fc1\u79fb\u8d2d\u7269\u8f66\u9879\n        migrated_items = migrate_cart_items(anonymous_pk, user_pk)\n    except Exception as e:\n        return jsonify({'message': f'Failed to migrate cart: {str(e)}'}), 500\n    \n    # \u83b7\u53d6\u8fc1\u79fb\u540e\u7684\u8d2d\u7269\u8f66\n    product_list = get_cart_items(user_pk)\n    \n    # \u6e05\u7406\u8fd4\u56de\u6570\u636e\u683c\u5f0f\n    for product in product_list:\n        if 'sk' in product:\n            product['sk'] = product['sk'].replace('product#', '')\n    \n    response = make_response(jsonify({'products': product_list}))\n    response = set_cart_cookie(response, cart_id)\n    return response, 200\n\n\n@app.route('/cart/checkout', methods=['POST'])\n@login_required\ndef checkout_cart():\n    \"\"\"\u7ed3\u7b97\u8d2d\u7269\u8f66\uff08\u6e05\u7a7a\u8d2d\u7269\u8f66\uff09\"\"\"\n    cart_id, _ = get_cart_id_from_cookie()\n    user_id = request.user_id\n    user_pk = f\"user#{user_id}\"\n    \n    # \u83b7\u53d6\u8d2d\u7269\u8f66\u9879\n    cart_items = get_cart_items(user_pk)\n    \n    try:\n        # \u6e05\u7a7a\u8d2d\u7269\u8f66\u524d\uff0c\u9700\u8981\u66f4\u65b0\u5546\u54c1\u7edf\u8ba1\uff08\u51cf\u5c11\u6570\u91cf\uff09\n        for item in cart_items:\n            product_id = item['sk'].replace('product#', '')\n            quantity = -item['quantity']  # \u8d1f\u6570\u8868\u793a\u51cf\u5c11\n            update_product_total_quantity(product_id, quantity)\n        \n        # \u5220\u9664\u8d2d\u7269\u8f66\u9879\n        delete_cart_items(user_pk)\n    except Exception as e:\n        return jsonify({'message': f'Failed to checkout: {str(e)}'}), 500\n    \n    response = make_response(jsonify({\n        'products': cart_items,\n        'message': 'Checkout successful'\n    }))\n    response = set_cart_cookie(response, cart_id)\n    return response, 200", "mimetype": "text/plain", "start_char_idx": 6768, "end_char_idx": 10193, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "792feee5-ec29-461c-86fc-444dd3d193e4": {"__data__": {"id_": "792feee5-ec29-461c-86fc-444dd3d193e4", "embedding": null, "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b2605c63-2361-4db8-99e1-d0a5f0526b14", "node_type": "4", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "a61d14a535d2b3f4237abd58ec8cb19d2814dcbbed86e8bb1265ede73b56e709", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f896041d-0b3c-47fc-b603-529d277d2d10", "node_type": "1", "metadata": {"file_path": "app.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 393}, "hash": "1be92eb48999f16342d7de46a5ec08f1ee8f7358f616e6f20a388559acfbbffa", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "@app.route('/cart/<product_id>/total', methods=['GET'])\ndef get_cart_total(product_id):\n    \"\"\"\u83b7\u53d6\u6307\u5b9a\u5546\u54c1\u5728\u6240\u6709\u8d2d\u7269\u8f66\u4e2d\u7684\u603b\u6570\u91cf\"\"\"\n    try:\n        total = get_product_total_quantity(product_id)\n    except Exception as e:\n        return jsonify({'message': f'Failed to get total: {str(e)}'}), 500\n    \n    return jsonify({\n        'product': product_id,\n        'quantity': total\n    }), 200\n\n\n# ==================== \u9519\u8bef\u5904\u7406 ====================\n\n@app.errorhandler(500)\ndef internal_error(error):\n    \"\"\"500\u9519\u8bef\u5904\u7406\"\"\"\n    return jsonify({'message': 'Internal server error'}), 500\n\n\n# ==================== \u5e94\u7528\u5165\u53e3 ====================\n\nif __name__ == '__main__':\n    port = int(os.environ.get('PORT', 5000))\n    debug = os.environ.get('DEBUG', 'True').lower() == 'true'\n    app.run(host='0.0.0.0', port=port, debug=debug)", "mimetype": "text/plain", "start_char_idx": 10196, "end_char_idx": 10992, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "31011200-baf0-4b72-b425-db78783cd938": {"__data__": {"id_": "31011200-baf0-4b72-b425-db78783cd938", "embedding": null, "metadata": {"file_path": "auth.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 87}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58d0341e-ba90-47ec-8994-f7961dbe9118", "node_type": "4", "metadata": {"file_path": "auth.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 87}, "hash": "195d6dfb612a1f904c17703bea08c767a6b9c0b557a507257815cc459670486a", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "\"\"\"\n\u7528\u6237\u8ba4\u8bc1\u6a21\u5757\n\u63d0\u4f9bJWT token\u751f\u6210\u548c\u9a8c\u8bc1\uff0c\u5bc6\u7801\u52a0\u5bc6\u7b49\u529f\u80fd\n\"\"\"\nimport os\nimport jwt\nfrom datetime import datetime, timedelta\nfrom werkzeug.security import generate_password_hash, check_password_hash\n\n\n# JWT\u914d\u7f6e\nSECRET_KEY = os.environ.get('SECRET_KEY', 'dev-secret-key-change-in-production')\nALGORITHM = 'HS256'\nTOKEN_EXPIRATION_HOURS = 24\n\n\ndef create_token(user_id, username):\n    \"\"\"\n    \u521b\u5efaJWT token\n    \n    Args:\n        user_id: \u7528\u6237ID\n        username: \u7528\u6237\u540d\n    \n    Returns:\n        JWT token\u5b57\u7b26\u4e32\n    \"\"\"\n    payload = {\n        'sub': user_id,\n        'username': username,\n        'exp': datetime.utcnow() + timedelta(hours=TOKEN_EXPIRATION_HOURS),\n        'iat': datetime.utcnow()\n    }\n    \n    token = jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)\n    return token\n\n\ndef verify_token(token):\n    \"\"\"\n    \u9a8c\u8bc1JWT token\n    \n    Args:\n        token: JWT token\u5b57\u7b26\u4e32\n    \n    Returns:\n        \u89e3\u7801\u540e\u7684payload\u5b57\u5178\n    \n    Raises:\n        jwt.ExpiredSignatureError: token\u5df2\u8fc7\u671f\n        jwt.InvalidTokenError: token\u65e0\u6548\n    \"\"\"\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        return payload\n    except jwt.ExpiredSignatureError:\n        raise Exception('Token has expired')\n    except jwt.InvalidTokenError:\n        raise Exception('Invalid token')\n\n\ndef hash_password(password):\n    \"\"\"\n    \u52a0\u5bc6\u5bc6\u7801\n    \n    Args:\n        password: \u660e\u6587\u5bc6\u7801\n    \n    Returns:\n        \u52a0\u5bc6\u540e\u7684\u5bc6\u7801\u54c8\u5e0c\n    \"\"\"\n    return generate_password_hash(password, method='pbkdf2:sha256')\n\n\ndef verify_password(password, password_hash):\n    \"\"\"\n    \u9a8c\u8bc1\u5bc6\u7801\n    \n    Args:\n        password: \u660e\u6587\u5bc6\u7801\n        password_hash: \u5bc6\u7801\u54c8\u5e0c\n    \n    Returns:\n        \u5e03\u5c14\u503c\uff0c\u8868\u793a\u5bc6\u7801\u662f\u5426\u5339\u914d\n    \"\"\"\n    return check_password_hash(password_hash, password)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1690, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "1f82accb-09fd-405b-84c3-1c89768c4da0": {"__data__": {"id_": "1f82accb-09fd-405b-84c3-1c89768c4da0", "embedding": null, "metadata": {"file_path": "db.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 47}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c3135f56-ce94-468c-94f9-97128b11f7b6", "node_type": "4", "metadata": {"file_path": "db.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 47}, "hash": "de616e9363ecd7bc27c79488829d644f86bf18b635167277b17ab9d498f0136e", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "\"\"\"\nDynamoDB \u6570\u636e\u5e93\u8fde\u63a5\u7ba1\u7406\n\u63d0\u4f9b\u6570\u636e\u5e93\u5ba2\u6237\u7aef\u548c\u8d44\u6e90\u5bf9\u8c61\u7684\u8bbf\u95ee\n\"\"\"\nimport os\nimport boto3\nfrom flask import g\n\n\n# DynamoDB\u914d\u7f6e\nAWS_REGION = os.environ.get('AWS_REGION', 'us-east-1')\nTABLE_NAME = os.environ.get('DYNAMODB_TABLE_NAME', 'shopping-cart-monolith')\n\n\ndef get_dynamodb_client():\n    \"\"\"\u83b7\u53d6DynamoDB\u5ba2\u6237\u7aef\uff08\u4f4e\u7ea7API\uff09\"\"\"\n    client = getattr(g, '_dynamodb_client', None)\n    if client is None:\n        client = g._dynamodb_client = boto3.client(\n            'dynamodb',\n            region_name=AWS_REGION\n        )\n    return client\n\n\ndef get_dynamodb_resource():\n    \"\"\"\u83b7\u53d6DynamoDB\u8d44\u6e90\u5bf9\u8c61\uff08\u9ad8\u7ea7API\uff09\"\"\"\n    resource = getattr(g, '_dynamodb_resource', None)\n    if resource is None:\n        resource = g._dynamodb_resource = boto3.resource(\n            'dynamodb',\n            region_name=AWS_REGION\n        )\n    return resource\n\n\ndef get_table():\n    \"\"\"\u83b7\u53d6\u8d2d\u7269\u8f66\u4e3b\u8868\"\"\"\n    dynamodb = get_dynamodb_resource()\n    return dynamodb.Table(TABLE_NAME)\n\n\ndef close_connection(exception):\n    \"\"\"\u6e05\u7406\u8fde\u63a5\uff08DynamoDB SDK\u4f1a\u81ea\u52a8\u7ba1\u7406\u8fde\u63a5\u6c60\uff0c\u6b64\u51fd\u6570\u4fdd\u7559\u7528\u4e8e\u517c\u5bb9\u6027\uff09\"\"\"\n    # \u79fb\u9664\u7f13\u5b58\u7684\u5ba2\u6237\u7aef\u548c\u8d44\u6e90\u5bf9\u8c61\n    g.pop('_dynamodb_client', None)\n    g.pop('_dynamodb_resource', None)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1083, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "97c9bca3-caee-48fa-9476-47547f90dae3": {"__data__": {"id_": "97c9bca3-caee-48fa-9476-47547f90dae3", "embedding": null, "metadata": {"file_path": "init_dynamodb.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 141}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "928d59ff-4411-421a-b861-1616c662a020", "node_type": "4", "metadata": {"file_path": "init_dynamodb.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 141}, "hash": "963d3d987bb4885fefbd08014bd4ca2e034f0752c20f400ddde0110d33645421", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1814ade2-b440-4637-85ac-6ac3cb4c6a7f", "node_type": "1", "metadata": {}, "hash": "d150a36de1821e513219a8931dd8495191dac19753a6e121eec8d423d1109d53", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "\"\"\"\nDynamoDB\u8868\u521d\u59cb\u5316\u811a\u672c\n\u521b\u5efa\u8d2d\u7269\u8f66\u5e94\u7528\u6240\u9700\u7684DynamoDB\u8868\n\n\u4f7f\u7528\u65b9\u6cd5\uff1a\n  python init_dynamodb.py\n\"\"\"\nimport os\nimport sys\nimport boto3\nfrom botocore.exceptions import ClientError\n\n\n# DynamoDB\u914d\u7f6e\nAWS_REGION = os.environ.get('AWS_REGION', 'us-east-1')\nTABLE_NAME = os.environ.get('DYNAMODB_TABLE_NAME', 'shopping-cart-monolith')\n\n\ndef get_dynamodb_resource():\n    \"\"\"\u83b7\u53d6DynamoDB\u8d44\u6e90\u5bf9\u8c61\"\"\"\n    return boto3.resource(\n        'dynamodb',\n        region_name=AWS_REGION\n    )\n\n\ndef init_dynamodb():\n    \"\"\"\n    \u521d\u59cb\u5316DynamoDB\u8868\u7ed3\u6784\n    \u521b\u5efa\u4e00\u4e2a\u5355\u8868\u8bbe\u8ba1\uff0c\u7528\u4e8e\u5b58\u50a8\u7528\u6237\u3001\u8d2d\u7269\u8f66\u548c\u5546\u54c1\u7edf\u8ba1\u6570\u636e\n    \"\"\"\n    dynamodb = get_dynamodb_resource()\n    \n    try:\n        # \u68c0\u67e5\u8868\u662f\u5426\u5df2\u5b58\u5728\n        existing_tables = dynamodb.meta.client.list_tables()['TableNames']\n        if TABLE_NAME in existing_tables:\n            print(f\"\u8868 {TABLE_NAME} \u5df2\u5b58\u5728\uff0c\u8df3\u8fc7\u521b\u5efa\")\n            return\n        \n        # \u521b\u5efa\u4e3b\u8868 - \u4f7f\u7528\u5355\u8868\u8bbe\u8ba1\n        # pk (Partition Key) \u548c sk (Sort Key) \u7528\u4e8e\u533a\u5206\u4e0d\u540c\u7c7b\u578b\u7684\u6570\u636e\uff1a\n        # - \u7528\u6237: pk='USER#{username}', sk='PROFILE'\n        # - \u8d2d\u7269\u8f66\u9879: pk='user#{userId}' \u6216 'cart#{cartId}', sk='product#{productId}'\n        # - \u5546\u54c1\u7edf\u8ba1: pk='PRODUCT#{productId}', sk='TOTAL'\n        table = dynamodb.create_table(\n            TableName=TABLE_NAME,\n            KeySchema=[\n                {'AttributeName': 'pk', 'KeyType': 'HASH'},   # Partition key\n                {'AttributeName': 'sk', 'KeyType': 'RANGE'}   # Sort key\n            ],\n            AttributeDefinitions=[\n                {'AttributeName': 'pk', 'AttributeType': 'S'},\n                {'AttributeName': 'sk', 'AttributeType': 'S'},\n                {'AttributeName': 'username', 'AttributeType': 'S'}  # GSI\n            ],\n            # \u6dfb\u52a0\u5168\u5c40\u4e8c\u7ea7\u7d22\u5f15\u7528\u4e8e\u901a\u8fc7username\u67e5\u8be2\u7528\u6237\n            GlobalSecondaryIndexes=[\n                {\n                    'IndexName': 'username-index',\n                    'KeySchema': [\n                        {'AttributeName': 'username', 'KeyType': 'HASH'}\n                    ],\n                    'Projection': {'ProjectionType': 'ALL'},\n                    'ProvisionedThroughput': {\n                        'ReadCapacityUnits': 5,\n                        'WriteCapacityUnits': 5\n                    }\n                }\n            ],\n            BillingMode='PROVISIONED',\n            ProvisionedThroughput={\n                'ReadCapacityUnits': 5,\n                'WriteCapacityUnits': 5\n            }\n        )\n        \n        # \u7b49\u5f85\u8868\u521b\u5efa\u5b8c\u6210\n        print(f\"\u6b63\u5728\u521b\u5efa\u8868 {TABLE_NAME}...\")\n        table.meta.client.get_waiter('table_exists').wait(TableName=TABLE_NAME)\n        print(f\"\u8868 {TABLE_NAME} \u521b\u5efa\u6210\u529f\uff01\")\n        \n        # \u542f\u7528TTL\uff08\u7528\u4e8e\u81ea\u52a8\u6e05\u7406\u8fc7\u671f\u7684\u8d2d\u7269\u8f66\u9879\uff09\n        try:\n            dynamodb.meta.client.update_time_to_live(\n                TableName=TABLE_NAME,\n                TimeToLiveSpecification={\n                    'Enabled': True,\n                    'AttributeName': 'expirationTime'\n                }\n            )\n            print(f\"\u8868 {TABLE_NAME} \u7684TTL\u5df2\u542f\u7528\")\n        except Exception as e:\n            print(f\"\u542f\u7528TTL\u65f6\u51fa\u9519\uff08\u53ef\u5ffd\u7565\uff09: {e}\")\n            \n    except ClientError as e:\n        if e.response['Error']['Code'] == 'ResourceInUseException':\n            print(f\"\u8868 {TABLE_NAME} \u5df2\u5b58\u5728\")\n        else:\n            print(f\"\u521b\u5efa\u8868\u65f6\u51fa\u9519: {e}\")\n            raise\n    except Exception as e:\n        print(f\"\u521d\u59cb\u5316DynamoDB\u65f6\u51fa\u9519: {e}\")\n        raise", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3198, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "1814ade2-b440-4637-85ac-6ac3cb4c6a7f": {"__data__": {"id_": "1814ade2-b440-4637-85ac-6ac3cb4c6a7f", "embedding": null, "metadata": {"file_path": "init_dynamodb.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 141}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "928d59ff-4411-421a-b861-1616c662a020", "node_type": "4", "metadata": {"file_path": "init_dynamodb.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 141}, "hash": "963d3d987bb4885fefbd08014bd4ca2e034f0752c20f400ddde0110d33645421", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "97c9bca3-caee-48fa-9476-47547f90dae3", "node_type": "1", "metadata": {"file_path": "init_dynamodb.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 141}, "hash": "5404089ac7472980e9a62b9a8c96e7a12fb91f82a7862eb0fb94d8d99a54a8bd", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "def main():\n    \"\"\"\u4e3b\u51fd\u6570\"\"\"\n    print('========================================')\n    print('\u8d2d\u7269\u8f66\u5e94\u7528 - DynamoDB\u8868\u521d\u59cb\u5316')\n    print('========================================')\n    print(f'\u533a\u57df: {AWS_REGION}')\n    print('')\n    \n    try:\n        init_dynamodb()\n        \n        print('')\n        print('========================================')\n        print('\u2713 \u6570\u636e\u5e93\u521d\u59cb\u5316\u5b8c\u6210\uff01')\n        print('========================================')\n        print('')\n        print('\u521b\u5efa\u7684\u8868:')\n        print(f'  1. {TABLE_NAME} - \u8d2d\u7269\u8f66\u4e3b\u8868\uff08\u5355\u8868\u8bbe\u8ba1\uff09')\n        print('')\n        print('\u73b0\u5728\u53ef\u4ee5\u542f\u52a8\u5e94\u7528\u4e86:')\n        print('  python app.py')\n        print('')\n        \n    except Exception as e:\n        print('')\n        print('========================================')\n        print('\u2717 \u521d\u59cb\u5316\u5931\u8d25\uff01')\n        print('========================================')\n        print(f'\u9519\u8bef\u4fe1\u606f: {e}')\n        print('')\n        sys.exit(1)\n\n\nif __name__ == '__main__':\n    main()", "mimetype": "text/plain", "start_char_idx": 3201, "end_char_idx": 4113, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "a4729e92-cc77-460a-9ef9-bc01b34413f6": {"__data__": {"id_": "a4729e92-cc77-460a-9ef9-bc01b34413f6", "embedding": null, "metadata": {"file_path": "load_products.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 70}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "67176075-a0f3-442c-ad0d-66efe795fb45", "node_type": "4", "metadata": {"file_path": "load_products.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 70}, "hash": "2f46d6dedc97cac86dc13e77e4e68e0a5ff345b53d9201b4fe5265aeb29d4665", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "#!/usr/bin/env python3\n\"\"\"\n\u4ea7\u54c1\u6570\u636e\u52a0\u8f7d\u811a\u672c\n\u5c06product_list.json\u4e2d\u7684\u4ea7\u54c1\u6570\u636e\u52a0\u8f7d\u5230DynamoDB\uff08\u53ef\u9009\uff09\n\u6ce8\u610f\uff1a\u5f53\u524d\u5e94\u7528\u4eceJSON\u6587\u4ef6\u8bfb\u53d6\u4ea7\u54c1\uff0c\u6b64\u811a\u672c\u4e3a\u672a\u6765\u6269\u5c55\u9884\u7559\n\"\"\"\nimport json\nimport os\nfrom datetime import datetime\nfrom db import get_table\n\n\ndef load_products_to_dynamodb():\n    \"\"\"\n    \u5c06\u4ea7\u54c1\u6570\u636e\u52a0\u8f7d\u5230DynamoDB\n    \u4ea7\u54c1\u8bb0\u5f55\u683c\u5f0f: pk='PRODUCT#{productId}', sk='DETAIL'\n    \"\"\"\n    # \u8bfb\u53d6\u4ea7\u54c1\u6570\u636e\n    current_dir = os.path.dirname(os.path.abspath(__file__))\n    product_file = os.path.join(current_dir, 'product_list.json')\n    \n    print(f\"\u6b63\u5728\u8bfb\u53d6\u4ea7\u54c1\u6570\u636e: {product_file}\")\n    with open(product_file, 'r', encoding='utf-8') as f:\n        products = json.load(f)\n    \n    print(f\"\u627e\u5230 {len(products)} \u4e2a\u4ea7\u54c1\")\n    \n    # \u83b7\u53d6DynamoDB\u8868\n    table = get_table()\n    \n    # \u6279\u91cf\u5199\u5165\u4ea7\u54c1\u6570\u636e\n    print(\"\u5f00\u59cb\u5199\u5165DynamoDB...\")\n    with table.batch_writer() as batch:\n        for product in products:\n            product_id = product['productId']\n            \n            # \u4ea7\u54c1\u8be6\u60c5\u8bb0\u5f55\n            item = {\n                'pk': f'PRODUCT#{product_id}',\n                'sk': 'DETAIL',\n                'productId': product_id,\n                'name': product.get('name', ''),\n                'price': product.get('price', 0),\n                'description': product.get('description', ''),\n                'picture': product.get('picture', ''),\n                'created_at': datetime.now().isoformat()\n            }\n            \n            batch.put_item(Item=item)\n            print(f\"  - \u5df2\u52a0\u8f7d: {product.get('name', product_id)}\")\n    \n    print(f\"\\n\u2713 \u6210\u529f\u52a0\u8f7d {len(products)} \u4e2a\u4ea7\u54c1\u5230DynamoDB\uff01\")\n\n\nif __name__ == '__main__':\n    print(\"=\" * 60)\n    print(\"\u4ea7\u54c1\u6570\u636e\u52a0\u8f7d\u811a\u672c\")\n    print(\"=\" * 60)\n    print(\"\\n\u6ce8\u610f\uff1a\u5f53\u524d\u5e94\u7528\u76f4\u63a5\u4eceproduct_list.json\u8bfb\u53d6\u4ea7\u54c1\u6570\u636e\")\n    print(\"\u6b64\u811a\u672c\u7528\u4e8e\u5c06\u4ea7\u54c1\u6570\u636e\u52a0\u8f7d\u5230DynamoDB\uff08\u53ef\u9009\u64cd\u4f5c\uff09\")\n    print(\"\\n\u5982\u679c\u60a8\u5e0c\u671b\u4eceDynamoDB\u8bfb\u53d6\u4ea7\u54c1\uff0c\u9700\u8981\u4fee\u6539app.py\u4e2d\u7684\u4ea7\u54c1\u76f8\u5173\u63a5\u53e3\\n\")\n    \n    try:\n        load_products_to_dynamodb()\n    except Exception as e:\n        print(f\"\\n\u2717 \u52a0\u8f7d\u5931\u8d25: {e}\")\n        import traceback\n        traceback.print_exc()\n        exit(1)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1891, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "3163b999-8fa3-472d-a062-3f4d94af1d66": {"__data__": {"id_": "3163b999-8fa3-472d-a062-3f4d94af1d66", "embedding": null, "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "572c1987-a7ac-4231-a539-34661fb41e8b", "node_type": "4", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ad2fac187d956b205a2c31f55e7f2d90bdea6a00acddc488bb08f703b2d85337", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e2422553-aca1-4c73-bcdd-4a8ca2abd5e3", "node_type": "1", "metadata": {}, "hash": "5fb12bd8b0ecfea9d04248db54a756cac8b8d6464be1dc1dff07417ae27cc42b", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "\"\"\"\n\u6570\u636e\u6a21\u578b\u548c\u6570\u636e\u5e93\u64cd\u4f5c\n\u63d0\u4f9b\u7528\u6237\u3001\u8d2d\u7269\u8f66\u3001\u5546\u54c1\u7edf\u8ba1\u7b49\u6570\u636e\u7684CRUD\u64cd\u4f5c\n\u4f7f\u7528DynamoDB\u4f5c\u4e3a\u6570\u636e\u5b58\u50a8\n\"\"\"\nimport json\nfrom uuid import uuid4\nfrom datetime import datetime, timedelta\nfrom decimal import Decimal\nfrom boto3.dynamodb.conditions import Key, Attr\nfrom botocore.exceptions import ClientError\n\nfrom db import get_table\nfrom auth import hash_password\n\n\n# ==================== \u8f85\u52a9\u51fd\u6570 ====================\n\ndef _python_obj_to_dynamodb(obj):\n    \"\"\"\n    \u5c06Python\u5bf9\u8c61\u8f6c\u6362\u4e3aDynamoDB\u517c\u5bb9\u7684\u683c\u5f0f\n    \u4e3b\u8981\u5904\u7406float\u5230Decimal\u7684\u8f6c\u6362\n    \"\"\"\n    if isinstance(obj, dict):\n        return {k: _python_obj_to_dynamodb(v) for k, v in obj.items()}\n    elif isinstance(obj, list):\n        return [_python_obj_to_dynamodb(item) for item in obj]\n    elif isinstance(obj, float):\n        return Decimal(str(obj))\n    else:\n        return obj\n\n\ndef _dynamodb_to_python_obj(obj):\n    \"\"\"\n    \u5c06DynamoDB\u5bf9\u8c61\u8f6c\u6362\u4e3aPython\u6807\u51c6\u5bf9\u8c61\n    \u4e3b\u8981\u5904\u7406Decimal\u5230float\u7684\u8f6c\u6362\n    \"\"\"\n    if isinstance(obj, dict):\n        return {k: _dynamodb_to_python_obj(v) for k, v in obj.items()}\n    elif isinstance(obj, list):\n        return [_dynamodb_to_python_obj(item) for item in obj]\n    elif isinstance(obj, Decimal):\n        # \u5982\u679c\u662f\u6574\u6570\uff0c\u8fd4\u56deint\uff1b\u5426\u5219\u8fd4\u56defloat\n        if obj % 1 == 0:\n            return int(obj)\n        else:\n            return float(obj)\n    else:\n        return obj\n\n\n# ==================== \u7528\u6237\u76f8\u5173\u64cd\u4f5c ====================\n\ndef create_user(username, password, email=None):\n    \"\"\"\n    \u521b\u5efa\u65b0\u7528\u6237\n    \n    Args:\n        username: \u7528\u6237\u540d\n        password: \u660e\u6587\u5bc6\u7801\n        email: \u90ae\u7bb1\uff08\u53ef\u9009\uff09\n    \n    Returns:\n        \u7528\u6237ID\n    \"\"\"\n    table = get_table()\n    user_id = str(uuid4())\n    password_hash = hash_password(password)\n    \n    # \u7528\u6237\u8bb0\u5f55: pk='USER#{username}', sk='PROFILE'\n    item = {\n        'pk': f'USER#{username}',\n        'sk': 'PROFILE',\n        'id': user_id,\n        'username': username,\n        'password_hash': password_hash,\n        'email': email,\n        'created_at': datetime.now().isoformat()\n    }\n    \n    try:\n        # \u4f7f\u7528\u6761\u4ef6\u8868\u8fbe\u5f0f\u786e\u4fdd\u7528\u6237\u540d\u552f\u4e00\n        table.put_item(\n            Item=item,\n            ConditionExpression='attribute_not_exists(pk)'\n        )\n    except ClientError as e:\n        if e.response['Error']['Code'] == 'ConditionalCheckFailedException':\n            raise Exception(f'\u7528\u6237\u540d {username} \u5df2\u5b58\u5728')\n        raise\n    \n    return user_id\n\n\ndef get_user_by_username(username):\n    \"\"\"\n    \u6839\u636e\u7528\u6237\u540d\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n    \n    Args:\n        username: \u7528\u6237\u540d\n    \n    Returns:\n        \u7528\u6237\u5b57\u5178\u6216None\n    \"\"\"\n    table = get_table()\n    \n    try:\n        response = table.get_item(\n            Key={\n                'pk': f'USER#{username}',\n                'sk': 'PROFILE'\n            }\n        )\n        \n        if 'Item' in response:\n            return _dynamodb_to_python_obj(response['Item'])\n        return None\n    except Exception as e:\n        print(f\"\u83b7\u53d6\u7528\u6237\u5931\u8d25: {e}\")\n        return None\n\n\ndef get_user_by_id(user_id):\n    \"\"\"\n    \u6839\u636e\u7528\u6237ID\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n    \n    Args:\n        user_id: \u7528\u6237ID\n    \n    Returns:\n        \u7528\u6237\u5b57\u5178\u6216None\n    \"\"\"\n    table = get_table()\n    \n    # \u7531\u4e8e\u6211\u4eec\u4f7f\u7528username\u4f5c\u4e3a\u4e3b\u952e\u7684\u4e00\u90e8\u5206\uff0c\u9700\u8981\u626b\u63cf\u8868\n    # \u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5efa\u8bae\u6dfb\u52a0GSI\u6765\u4f18\u5316\u8fd9\u4e2a\u67e5\u8be2\n    try:\n        response = table.scan(\n            FilterExpression=Attr('id').eq(user_id) & Attr('sk').eq('PROFILE')\n        )\n        \n        if response['Items']:\n            return _dynamodb_to_python_obj(response['Items'][0])\n        return None\n    except Exception as e:\n        print(f\"\u83b7\u53d6\u7528\u6237\u5931\u8d25: {e}\")\n        return None", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3327, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "e2422553-aca1-4c73-bcdd-4a8ca2abd5e3": {"__data__": {"id_": "e2422553-aca1-4c73-bcdd-4a8ca2abd5e3", "embedding": null, "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "572c1987-a7ac-4231-a539-34661fb41e8b", "node_type": "4", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ad2fac187d956b205a2c31f55e7f2d90bdea6a00acddc488bb08f703b2d85337", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3163b999-8fa3-472d-a062-3f4d94af1d66", "node_type": "1", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "0e0db2d13a48bf0c29473dad2867a1f5f5ea0df6529d45c1e3f814b459732552", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "33f34b8e-968c-463d-a085-4b3a977ccb89", "node_type": "1", "metadata": {}, "hash": "cf66a0c59437f0f5d1fbca4f259c63569c7ba2ef113066127408e7c2cba2847f", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "def get_user_by_id(user_id):\n    \"\"\"\n    \u6839\u636e\u7528\u6237ID\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n    \n    Args:\n        user_id: \u7528\u6237ID\n    \n    Returns:\n        \u7528\u6237\u5b57\u5178\u6216None\n    \"\"\"\n    table = get_table()\n    \n    # \u7531\u4e8e\u6211\u4eec\u4f7f\u7528username\u4f5c\u4e3a\u4e3b\u952e\u7684\u4e00\u90e8\u5206\uff0c\u9700\u8981\u626b\u63cf\u8868\n    # \u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5efa\u8bae\u6dfb\u52a0GSI\u6765\u4f18\u5316\u8fd9\u4e2a\u67e5\u8be2\n    try:\n        response = table.scan(\n            FilterExpression=Attr('id').eq(user_id) & Attr('sk').eq('PROFILE')\n        )\n        \n        if response['Items']:\n            return _dynamodb_to_python_obj(response['Items'][0])\n        return None\n    except Exception as e:\n        print(f\"\u83b7\u53d6\u7528\u6237\u5931\u8d25: {e}\")\n        return None\n\n\n# ==================== \u8d2d\u7269\u8f66\u76f8\u5173\u64cd\u4f5c ====================\n\ndef get_cart_items(pk):\n    \"\"\"\n    \u83b7\u53d6\u8d2d\u7269\u8f66\u4e2d\u7684\u6240\u6709\u5546\u54c1\n    \n    Args:\n        pk: \u4e3b\u952e\uff08user#xxx \u6216 cart#xxx\uff09\n    \n    Returns:\n        \u5546\u54c1\u5217\u8868\n    \"\"\"\n    table = get_table()\n    \n    try:\n        # \u67e5\u8be2\u8d2d\u7269\u8f66\u9879\uff0c\u53ea\u83b7\u53d6product#\u5f00\u5934\u7684\u9879\n        response = table.query(\n            KeyConditionExpression=Key('pk').eq(pk) & Key('sk').begins_with('product#')\n        )\n        \n        items = []\n        current_time = datetime.now()\n        \n        for item in response['Items']:\n            # \u8fc7\u6ee4\u6389\u6570\u91cf\u4e3a0\u548c\u5df2\u8fc7\u671f\u7684\u9879\n            quantity = item.get('quantity', 0)\n            if quantity <= 0:\n                continue\n            \n            # \u68c0\u67e5\u662f\u5426\u8fc7\u671f\n            expiration_time = item.get('expirationTime')\n            if expiration_time:\n                # DynamoDB\u7684TTL\u662fUnix\u65f6\u95f4\u6233\uff08\u79d2\uff09\n                # \u9700\u8981\u5c06Decimal\u8f6c\u6362\u4e3aint\u6216float\n                if isinstance(expiration_time, Decimal):\n                    expiration_time = int(expiration_time)\n                exp_datetime = datetime.fromtimestamp(expiration_time)\n                if exp_datetime < current_time:\n                    continue\n            \n            # \u89e3\u6790product_detail\n            product_detail = item.get('product_detail')\n            if product_detail and isinstance(product_detail, str):\n                product_detail = json.loads(product_detail)\n            \n            items.append({\n                'sk': item['sk'],\n                'quantity': int(quantity) if isinstance(quantity, Decimal) else quantity,\n                'productDetail': _dynamodb_to_python_obj(product_detail)\n            })\n        \n        return items\n    except Exception as e:\n        print(f\"\u83b7\u53d6\u8d2d\u7269\u8f66\u5931\u8d25: {e}\")\n        return []\n\n\ndef add_cart_item(pk, product_id, quantity, product_detail, expiration_time):\n    \"\"\"\n    \u6dfb\u52a0\u6216\u66f4\u65b0\u8d2d\u7269\u8f66\u9879\uff08\u589e\u52a0\u6570\u91cf\uff09\n    \n    Args:\n        pk: \u4e3b\u952e\uff08user#xxx \u6216 cart#xxx\uff09\n        product_id: \u4ea7\u54c1ID\n        quantity: \u6570\u91cf\uff08\u53ef\u4ee5\u662f\u8d1f\u6570\uff09\n        product_detail: \u4ea7\u54c1\u8be6\u60c5\u5b57\u5178\n        expiration_time: \u8fc7\u671f\u65f6\u95f4\uff08datetime\u5bf9\u8c61\uff09\n    \"\"\"\n    table = get_table()\n    sk = f\"product#{product_id}\"\n    \n    # \u8f6c\u6362\u8fc7\u671f\u65f6\u95f4\u4e3aUnix\u65f6\u95f4\u6233\uff08DynamoDB TTL\u683c\u5f0f\uff09\n    ttl = int(expiration_time.timestamp()) if expiration_time else None\n    \n    # \u8f6c\u6362product_detail\u4e3aJSON\u5b57\u7b26\u4e32\n    product_detail_json = json.dumps(_python_obj_to_dynamodb(product_detail))\n    \n    try:\n        # \u4f7f\u7528UpdateItem\u5b9e\u73b0\u539f\u5b50\u6027\u7684\u589e\u91cf\u66f4\u65b0\n        response = table.update_item(\n            Key={'pk': pk, 'sk': sk},\n            UpdateExpression='ADD quantity :qty SET product_detail = :detail, expirationTime = :ttl, updated_at = :now',\n            ExpressionAttributeValues={\n                ':qty': quantity,\n                ':detail': product_detail_json,\n                ':ttl': ttl,\n                ':now': datetime.now().isoformat()\n            },\n            ReturnValues='ALL_NEW'\n        )\n        \n        # \u5982\u679c\u66f4\u65b0\u540e\u6570\u91cf\u5c0f\u4e8e\u7b49\u4e8e0\uff0c\u5220\u9664\u8be5\u9879\n        new_quantity = response['Attributes'].get('quantity', 0)\n        if new_quantity <= 0:\n            table.delete_item(Key={'pk': pk, 'sk': sk})\n            \n    except Exception as e:\n        print(f\"\u6dfb\u52a0\u8d2d\u7269\u8f66\u9879\u5931\u8d25: {e}\")\n        raise", "mimetype": "text/plain", "start_char_idx": 2771, "end_char_idx": 6378, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "33f34b8e-968c-463d-a085-4b3a977ccb89": {"__data__": {"id_": "33f34b8e-968c-463d-a085-4b3a977ccb89", "embedding": null, "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "572c1987-a7ac-4231-a539-34661fb41e8b", "node_type": "4", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ad2fac187d956b205a2c31f55e7f2d90bdea6a00acddc488bb08f703b2d85337", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e2422553-aca1-4c73-bcdd-4a8ca2abd5e3", "node_type": "1", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ffac5565e2dd115c40bdcea484d7156f91e2ad4839ec45eea37b80370222d7fd", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c18b2d1a-f010-4954-94d9-dabb551080c1", "node_type": "1", "metadata": {}, "hash": "9b1acb29d9fd385713a09093300347bde1189634d9f671a962978ca2407e9893", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "def update_cart_item_quantity(pk, product_id, quantity, product_detail, expiration_time):\n    \"\"\"\n    \u66f4\u65b0\u8d2d\u7269\u8f66\u9879\u6570\u91cf\uff08\u5e42\u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u8bbe\u7f6e\u4e3a\u6307\u5b9a\u6570\u91cf\uff09\n    \n    Args:\n        pk: \u4e3b\u952e\uff08user#xxx \u6216 cart#xxx\uff09\n        product_id: \u4ea7\u54c1ID\n        quantity: \u6570\u91cf\n        product_detail: \u4ea7\u54c1\u8be6\u60c5\u5b57\u5178\n        expiration_time: \u8fc7\u671f\u65f6\u95f4\uff08datetime\u5bf9\u8c61\uff09\n    \"\"\"\n    table = get_table()\n    sk = f\"product#{product_id}\"\n    \n    # \u8f6c\u6362\u8fc7\u671f\u65f6\u95f4\u4e3aUnix\u65f6\u95f4\u6233\n    ttl = int(expiration_time.timestamp()) if expiration_time else None\n    \n    # \u8f6c\u6362product_detail\u4e3aJSON\u5b57\u7b26\u4e32\n    product_detail_json = json.dumps(_python_obj_to_dynamodb(product_detail))\n    \n    try:\n        if quantity <= 0:\n            # \u6570\u91cf\u4e3a0\u6216\u8d1f\u6570\uff0c\u5220\u9664\u8be5\u9879\n            table.delete_item(Key={'pk': pk, 'sk': sk})\n        else:\n            # \u76f4\u63a5\u8bbe\u7f6e\u6570\u91cf\n            table.put_item(\n                Item={\n                    'pk': pk,\n                    'sk': sk,\n                    'quantity': quantity,\n                    'product_detail': product_detail_json,\n                    'expirationTime': ttl,\n                    'updated_at': datetime.now().isoformat()\n                }\n            )\n    except Exception as e:\n        print(f\"\u66f4\u65b0\u8d2d\u7269\u8f66\u9879\u5931\u8d25: {e}\")\n        raise\n\n\ndef delete_cart_items(pk):\n    \"\"\"\n    \u5220\u9664\u6307\u5b9a\u7528\u6237/\u8d2d\u7269\u8f66\u7684\u6240\u6709\u5546\u54c1\n    \n    Args:\n        pk: \u4e3b\u952e\uff08user#xxx \u6216 cart#xxx\uff09\n    \"\"\"\n    table = get_table()\n    \n    try:\n        # \u5148\u67e5\u8be2\u6240\u6709\u8d2d\u7269\u8f66\u9879\n        response = table.query(\n            KeyConditionExpression=Key('pk').eq(pk) & Key('sk').begins_with('product#')\n        )\n        \n        # \u6279\u91cf\u5220\u9664\n        with table.batch_writer() as batch:\n            for item in response['Items']:\n                batch.delete_item(\n                    Key={\n                        'pk': item['pk'],\n                        'sk': item['sk']\n                    }\n                )\n    except Exception as e:\n        print(f\"\u5220\u9664\u8d2d\u7269\u8f66\u9879\u5931\u8d25: {e}\")\n        raise", "mimetype": "text/plain", "start_char_idx": 6381, "end_char_idx": 8205, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "c18b2d1a-f010-4954-94d9-dabb551080c1": {"__data__": {"id_": "c18b2d1a-f010-4954-94d9-dabb551080c1", "embedding": null, "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "572c1987-a7ac-4231-a539-34661fb41e8b", "node_type": "4", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ad2fac187d956b205a2c31f55e7f2d90bdea6a00acddc488bb08f703b2d85337", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "33f34b8e-968c-463d-a085-4b3a977ccb89", "node_type": "1", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ca57297caf28837ff80f11f508c7514b0b0585e7530242de97c1c5ea00eb5795", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c1a7f510-bc4b-4cc1-ad24-7af82d503be3", "node_type": "1", "metadata": {}, "hash": "488ca10c0036fa4a658c9060a7bdd235c6eb519b27ebfc56e760902fc95f1c90", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "def delete_cart_items(pk):\n    \"\"\"\n    \u5220\u9664\u6307\u5b9a\u7528\u6237/\u8d2d\u7269\u8f66\u7684\u6240\u6709\u5546\u54c1\n    \n    Args:\n        pk: \u4e3b\u952e\uff08user#xxx \u6216 cart#xxx\uff09\n    \"\"\"\n    table = get_table()\n    \n    try:\n        # \u5148\u67e5\u8be2\u6240\u6709\u8d2d\u7269\u8f66\u9879\n        response = table.query(\n            KeyConditionExpression=Key('pk').eq(pk) & Key('sk').begins_with('product#')\n        )\n        \n        # \u6279\u91cf\u5220\u9664\n        with table.batch_writer() as batch:\n            for item in response['Items']:\n                batch.delete_item(\n                    Key={\n                        'pk': item['pk'],\n                        'sk': item['sk']\n                    }\n                )\n    except Exception as e:\n        print(f\"\u5220\u9664\u8d2d\u7269\u8f66\u9879\u5931\u8d25: {e}\")\n        raise\n\n\ndef migrate_cart_items(anonymous_pk, user_pk):\n    \"\"\"\n    \u5c06\u533f\u540d\u8d2d\u7269\u8f66\u8fc1\u79fb\u5230\u7528\u6237\u8d26\u6237\n    \n    Args:\n        anonymous_pk: \u533f\u540d\u8d2d\u7269\u8f66\u4e3b\u952e\uff08cart#xxx\uff09\n        user_pk: \u7528\u6237\u4e3b\u952e\uff08user#xxx\uff09\n    \n    Returns:\n        \u8fc1\u79fb\u7684\u5546\u54c1\u5217\u8868\n    \"\"\"\n    table = get_table()\n    \n    try:\n        # \u83b7\u53d6\u533f\u540d\u8d2d\u7269\u8f66\u7684\u6240\u6709\u5546\u54c1\n        response = table.query(\n            KeyConditionExpression=Key('pk').eq(anonymous_pk) & Key('sk').begins_with('product#')\n        )\n        \n        anonymous_items = response['Items']\n        migrated_items = []\n        \n        # \u8fc1\u79fb\u5230\u7528\u6237\u8d26\u6237\n        for item in anonymous_items:\n            sk = item['sk']\n            quantity = item.get('quantity', 0)\n            # \u5904\u7406Decimal\u7c7b\u578b\n            if isinstance(quantity, Decimal):\n                quantity = int(quantity)\n            product_detail = item.get('product_detail')\n            \n            if quantity <= 0:\n                continue\n            \n            # \u8bbe\u7f6e\u65b0\u7684\u8fc7\u671f\u65f6\u95f4\uff08\u5df2\u767b\u5f55\u7528\u6237\u4fdd\u755930\u5929\uff09\n            expiration_time = datetime.now() + timedelta(days=30)\n            ttl = int(expiration_time.timestamp())\n            \n            # \u68c0\u67e5\u7528\u6237\u8d2d\u7269\u8f66\u662f\u5426\u5df2\u6709\u6b64\u5546\u54c1\n            try:\n                user_response = table.get_item(Key={'pk': user_pk, 'sk': sk})\n                \n                if 'Item' in user_response:\n                    # \u5df2\u5b58\u5728\u5219\u7d2f\u52a0\u6570\u91cf\uff08\u4f7f\u7528\u539f\u5b50\u6027ADD\u64cd\u4f5c\uff09\n                    table.update_item(\n                        Key={'pk': user_pk, 'sk': sk},\n                        UpdateExpression='ADD quantity :qty SET product_detail = :detail, expirationTime = :ttl, updated_at = :now',\n                        ExpressionAttributeValues={\n                            ':qty': quantity,\n                            ':detail': product_detail,\n                            ':ttl': ttl,\n                            ':now': datetime.now().isoformat()\n                        }\n                    )\n                else:\n                    # \u4e0d\u5b58\u5728\u5219\u63d2\u5165\n                    table.put_item(\n                        Item={\n                            'pk': user_pk,\n                            'sk': sk,\n                            'quantity': quantity,\n                            'product_detail': product_detail,\n                            'expirationTime': ttl,\n                            'updated_at': datetime.now().isoformat()\n                        }\n                    )\n            except Exception as e:\n                print(f\"\u8fc1\u79fb\u5546\u54c1 {sk} \u5931\u8d25: {e}\")\n                continue\n            \n            migrated_items.append({\n                'sk': sk,\n                'quantity': quantity,\n                'product_detail': product_detail\n            })\n        \n        # \u5220\u9664\u533f\u540d\u8d2d\u7269\u8f66\u7684\u5546\u54c1\n        delete_cart_items(anonymous_pk)\n        \n        return migrated_items\n        \n    except Exception as e:\n        print(f\"\u8fc1\u79fb\u8d2d\u7269\u8f66\u5931\u8d25: {e}\")\n        raise\n\n\n# ==================== \u5546\u54c1\u7edf\u8ba1\u76f8\u5173\u64cd\u4f5c ====================\n\ndef get_product_total_quantity(product_id):\n    \"\"\"\n    \u83b7\u53d6\u6307\u5b9a\u5546\u54c1\u5728\u6240\u6709\u8d2d\u7269\u8f66\u4e2d\u7684\u603b\u6570\u91cf\n    \n    Args:\n        product_id: \u4ea7\u54c1ID\n    \n    Returns:\n        \u603b\u6570\u91cf\n    \"\"\"\n    table = get_table()\n    \n    try:\n        response = table.get_item(\n            Key={\n                'pk': f'PRODUCT#{product_id}',\n                'sk': 'TOTAL'\n            }\n        )\n        \n        if 'Item' in response:\n            total = response['Item'].get('total_quantity', 0)\n            return int(total) if isinstance(total, Decimal) else total\n        return 0\n    except Exception as e:\n        print(f\"\u83b7\u53d6\u5546\u54c1\u7edf\u8ba1\u5931\u8d25: {e}\")\n        return 0", "mimetype": "text/plain", "start_char_idx": 7536, "end_char_idx": 11621, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}, "c1a7f510-bc4b-4cc1-ad24-7af82d503be3": {"__data__": {"id_": "c1a7f510-bc4b-4cc1-ad24-7af82d503be3", "embedding": null, "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "572c1987-a7ac-4231-a539-34661fb41e8b", "node_type": "4", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "ad2fac187d956b205a2c31f55e7f2d90bdea6a00acddc488bb08f703b2d85337", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c18b2d1a-f010-4954-94d9-dabb551080c1", "node_type": "1", "metadata": {"file_path": "models.py", "function_name": "whole_file", "type": "file", "start_line": 1, "end_line": 521}, "hash": "e0a67ccb7b3b15ecc7af65641e07349e59618acc728ef2c922d496d3ba9c7eb9", "class_name": "RelatedNodeInfo"}}, "metadata_template": "{key}: {value}", "metadata_separator": "\n", "text": "# ==================== \u5546\u54c1\u7edf\u8ba1\u76f8\u5173\u64cd\u4f5c ====================\n\ndef get_product_total_quantity(product_id):\n    \"\"\"\n    \u83b7\u53d6\u6307\u5b9a\u5546\u54c1\u5728\u6240\u6709\u8d2d\u7269\u8f66\u4e2d\u7684\u603b\u6570\u91cf\n    \n    Args:\n        product_id: \u4ea7\u54c1ID\n    \n    Returns:\n        \u603b\u6570\u91cf\n    \"\"\"\n    table = get_table()\n    \n    try:\n        response = table.get_item(\n            Key={\n                'pk': f'PRODUCT#{product_id}',\n                'sk': 'TOTAL'\n            }\n        )\n        \n        if 'Item' in response:\n            total = response['Item'].get('total_quantity', 0)\n            return int(total) if isinstance(total, Decimal) else total\n        return 0\n    except Exception as e:\n        print(f\"\u83b7\u53d6\u5546\u54c1\u7edf\u8ba1\u5931\u8d25: {e}\")\n        return 0\n\n\ndef update_product_total_quantity(product_id, quantity_change):\n    \"\"\"\n    \u66f4\u65b0\u5546\u54c1\u7684\u603b\u6570\u91cf\u7edf\u8ba1\uff08\u589e\u91cf\u66f4\u65b0\uff09\n    \n    Args:\n        product_id: \u4ea7\u54c1ID\n        quantity_change: \u6570\u91cf\u53d8\u5316\uff08\u53ef\u4ee5\u662f\u6b63\u6570\u6216\u8d1f\u6570\uff09\n    \"\"\"\n    table = get_table()\n    pk = f'PRODUCT#{product_id}'\n    sk = 'TOTAL'\n    \n    try:\n        # \u4f7f\u7528\u539f\u5b50\u6027\u7684ADD\u64cd\u4f5c\n        response = table.update_item(\n            Key={'pk': pk, 'sk': sk},\n            UpdateExpression='ADD total_quantity :change SET updated_at = :now',\n            ExpressionAttributeValues={\n                ':change': quantity_change,\n                ':now': datetime.now().isoformat()\n            },\n            ReturnValues='ALL_NEW'\n        )\n        \n        # \u5982\u679c\u603b\u6570\u5c0f\u4e8e0\uff0c\u91cd\u7f6e\u4e3a0\n        new_total = response['Attributes'].get('total_quantity', 0)\n        if new_total < 0:\n            table.update_item(\n                Key={'pk': pk, 'sk': sk},\n                UpdateExpression='SET total_quantity = :zero',\n                ExpressionAttributeValues={':zero': 0}\n            )\n    except ClientError as e:\n        if e.response['Error']['Code'] == 'ValidationException':\n            # \u5982\u679c\u8bb0\u5f55\u4e0d\u5b58\u5728\uff0c\u521b\u5efa\u65b0\u8bb0\u5f55\n            initial_total = max(0, quantity_change)\n            table.put_item(\n                Item={\n                    'pk': pk,\n                    'sk': sk,\n                    'total_quantity': initial_total,\n                    'updated_at': datetime.now().isoformat()\n                }\n            )\n        else:\n            print(f\"\u66f4\u65b0\u5546\u54c1\u7edf\u8ba1\u5931\u8d25: {e}\")\n            raise\n    except Exception as e:\n        print(f\"\u66f4\u65b0\u5546\u54c1\u7edf\u8ba1\u5931\u8d25: {e}\")\n        raise\n\n\n# ==================== \u6570\u636e\u6e05\u7406 ====================\n\ndef cleanup_expired_items():\n    \"\"\"\n    \u6e05\u7406\u8fc7\u671f\u7684\u8d2d\u7269\u8f66\u9879\n    \u6ce8\u610f\uff1aDynamoDB\u7684TTL\u4f1a\u81ea\u52a8\u6e05\u7406\u8fc7\u671f\u9879\uff0c\u6b64\u51fd\u6570\u4f5c\u4e3a\u5907\u7528\u624b\u52a8\u6e05\u7406\n    \"\"\"\n    table = get_table()\n    current_timestamp = int(datetime.now().timestamp())\n    \n    try:\n        # \u626b\u63cf\u6240\u6709\u8fc7\u671f\u7684\u8d2d\u7269\u8f66\u9879\n        response = table.scan(\n            FilterExpression=Attr('expirationTime').exists() & Attr('expirationTime').lt(current_timestamp)\n        )\n        \n        deleted_count = 0\n        with table.batch_writer() as batch:\n            for item in response['Items']:\n                batch.delete_item(\n                    Key={\n                        'pk': item['pk'],\n                        'sk': item['sk']\n                    }\n                )\n                deleted_count += 1\n        \n        return deleted_count\n    except Exception as e:\n        print(f\"\u6e05\u7406\u8fc7\u671f\u9879\u5931\u8d25: {e}\")\n        return 0", "mimetype": "text/plain", "start_char_idx": 10958, "end_char_idx": 14039, "metadata_seperator": "\n", "text_template": "{metadata_str}\n\n{content}", "class_name": "TextNode"}, "__type__": "1"}}}