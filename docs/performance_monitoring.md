# MAG ç³»ç»Ÿæ€§èƒ½ç›‘æ§ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

æ€§èƒ½ç›‘æ§ç³»ç»Ÿå·²é›†æˆåˆ° MAG ç³»ç»Ÿä¸­ï¼Œå¯ä»¥è‡ªåŠ¨è®°å½•å’Œåˆ†æç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ€§èƒ½æŒ‡æ ‡ï¼Œå¸®åŠ©ä½ è¯†åˆ«æ€§èƒ½ç“¶é¢ˆã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. LLM API è°ƒç”¨ç›‘æ§
- âœ… è®°å½•æ¯æ¬¡ LLM API è°ƒç”¨çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
- âœ… è®°å½• Token ä½¿ç”¨é‡ï¼ˆprompt tokensã€completion tokensã€total tokensï¼‰
- âœ… è®°å½•è°ƒç”¨æ¨¡å‹åç§°
- âœ… è®°å½•è°ƒç”¨ä¸Šä¸‹æ–‡ï¼ˆå“ªä¸ª Agent åœ¨å“ªä¸ª Task ä¸­è°ƒç”¨ï¼‰
- âœ… ç»Ÿè®¡ LLM è°ƒç”¨å æ€»æ‰§è¡Œæ—¶é—´çš„æ¯”ä¾‹

### 2. Agent æ‰§è¡Œç›‘æ§
- âœ… è®°å½•æ¯ä¸ª Agent çš„æ‰§è¡Œæ—¶é—´
- âœ… è®°å½• Agent çš„å„ç§æ“ä½œ
- âœ… å…³è” Agent ä¸å…·ä½“çš„ Task

### 3. Task æ‰§è¡Œç›‘æ§
- âœ… è®°å½•æ¯ä¸ª Task çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
- âœ… è®°å½• Task çš„è¾“å‡ºå¤§å°
- âœ… è®°å½• Task æ‰§è¡ŒçŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰

### 4. å·¥å…·è°ƒç”¨ç›‘æ§
- âœ… è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨çš„æ‰§è¡Œæ—¶é—´
- âœ… åŒºåˆ†ä¸åŒ Agent ä½¿ç”¨åŒä¸€å·¥å…·çš„æƒ…å†µ
- âœ… è®°å½•å·¥å…·è°ƒç”¨æˆåŠŸ/å¤±è´¥çŠ¶æ€

## å¦‚ä½•ä½¿ç”¨

### è¿è¡Œç³»ç»Ÿ

æ­£å¸¸è¿è¡Œ MAG ç³»ç»Ÿå³å¯ï¼Œæ€§èƒ½ç›‘æ§ä¼šè‡ªåŠ¨å¯ç”¨ï¼š

```bash
cd d:\AAAresearch\agent\crewai\mag-system
python -m src.main
```

### æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š

ç³»ç»Ÿæ‰§è¡Œå®Œæˆåï¼Œä¼šåœ¨ `storage/performance_logs/` ç›®å½•ä¸‹ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š

#### 1. è¯¦ç»†æŠ¥å‘Š (JSON æ ¼å¼)

æ–‡ä»¶åï¼š`performance_report_YYYYMMDD_HHMMSS.json`

åŒ…å«æ‰€æœ‰åŸå§‹æ•°æ®ï¼š
```json
{
  "session_id": "20260206_143025",
  "total_duration_seconds": 245.67,
  "summary": {
    "llm_calls": {
      "count": 15,
      "total_time_seconds": 180.23,
      "average_time_seconds": 12.02,
      "percentage_of_total": 73.4
    },
    "tasks": {...},
    "tool_calls": {...}
  },
  "llm_calls": [...],
  "task_times": [...],
  "agent_times": [...],
  "tool_calls": [...]
}
```

#### 2. ç»Ÿè®¡æ‘˜è¦ (æ–‡æœ¬æ ¼å¼)

æ–‡ä»¶åï¼š`performance_summary_YYYYMMDD_HHMMSS.txt`

äººç±»å¯è¯»çš„æ‘˜è¦æŠ¥å‘Šï¼š
```
================================================================================
æ€§èƒ½åˆ†ææŠ¥å‘Š - Session: 20260206_143025
================================================================================

ğŸ“Š æ€»æ‰§è¡Œæ—¶é—´: 245.67ç§’ (4.09åˆ†é’Ÿ)

================================================================================
ğŸ¤– LLM API è°ƒç”¨ç»Ÿè®¡
================================================================================
  è°ƒç”¨æ¬¡æ•°: 15
  æ€»è€—æ—¶: 180.23ç§’
  å¹³å‡è€—æ—¶: 12.02ç§’/æ¬¡
  å æ€»æ—¶é—´æ¯”ä¾‹: 73.4%

================================================================================
ğŸ“‹ Task æ‰§è¡Œç»Ÿè®¡
================================================================================
  ä»»åŠ¡æ•°é‡: 3
  æ€»è€—æ—¶: 240.15ç§’
  
  å„ä»»åŠ¡è€—æ—¶:
    - Architect Blueprint: 85.32ç§’ (Agent: architect)
    - Generate Application: 102.45ç§’ (Agent: code_developer)
    - Generate SAM Template: 52.38ç§’ (Agent: sam_engineer)

================================================================================
ğŸ”§ å·¥å…·è°ƒç”¨ç»Ÿè®¡
================================================================================
  è°ƒç”¨æ¬¡æ•°: 42
  æ€»è€—æ—¶: 8.45ç§’
  å æ€»æ—¶é—´æ¯”ä¾‹: 3.4%

================================================================================
ğŸ“ˆ æ—¶é—´åˆ†å¸ƒ
================================================================================
  LLM API è°ƒç”¨: 73.4% (180.23ç§’)
  å·¥å…·è°ƒç”¨: 3.4% (8.45ç§’)
  å…¶ä»–å¤„ç†: 23.2% (57.00ç§’)
```

## æ€§èƒ½åˆ†æå»ºè®®

### 1. è¯†åˆ« LLM è°ƒç”¨ç“¶é¢ˆ

å¦‚æœ LLM API è°ƒç”¨å æ€»æ—¶é—´çš„ **70% ä»¥ä¸Š**ï¼Œè¯´æ˜ä¸»è¦ç“¶é¢ˆåœ¨æ¨¡å‹å“åº”é€Ÿåº¦ï¼š

**è§£å†³æ–¹æ¡ˆï¼š**
- ğŸ”„ æ›´æ¢æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ä» deepseek-chat åˆ‡æ¢åˆ° gpt-4o-miniï¼‰
- ğŸ”„ ä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆå¦‚ Ollama + qwenï¼‰
- âš¡ ä¼˜åŒ– promptï¼Œå‡å°‘ä¸å¿…è¦çš„è¾“å…¥ tokens
- ğŸ”§ å¹¶è¡ŒåŒ–å¯ä»¥å¹¶è¡Œçš„ Agent ä»»åŠ¡ï¼ˆéœ€è¦ä¿®æ”¹æ¶æ„ï¼‰

### 2. è¯†åˆ«å·¥å…·è°ƒç”¨ç“¶é¢ˆ

å¦‚æœå·¥å…·è°ƒç”¨å æ€»æ—¶é—´çš„ **20% ä»¥ä¸Š**ï¼Œè¯´æ˜å·¥å…·æ•ˆç‡æœ‰é—®é¢˜ï¼š

**è§£å†³æ–¹æ¡ˆï¼š**
- ğŸ“ æ£€æŸ¥æ–‡ä»¶è¯»å†™æ˜¯å¦é¢‘ç¹
- ğŸ” æ£€æŸ¥ RAG æ£€ç´¢æ˜¯å¦è€—æ—¶è¿‡é•¿
- ğŸ’¾ æ·»åŠ ç¼“å­˜æœºåˆ¶

### 3. è¯†åˆ«å…¶ä»–å¤„ç†ç“¶é¢ˆ

å¦‚æœ"å…¶ä»–å¤„ç†"å æ€»æ—¶é—´çš„ **30% ä»¥ä¸Š**ï¼Œè¯´æ˜ Agent æ€è€ƒæˆ–æ¡†æ¶å¼€é”€è¾ƒå¤§ï¼š

**è§£å†³æ–¹æ¡ˆï¼š**
- ğŸ¯ ä¼˜åŒ– Agent çš„ prompt å’Œ backstoryï¼Œä½¿å…¶æ›´èšç„¦
- ğŸ”§ æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„é‡å¤æ“ä½œ
- ğŸ“Š æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šï¼Œå®šä½å…·ä½“è€—æ—¶çš„æ“ä½œ

## ç›‘æ§å®ç°åŸç†

### 1. LLM è°ƒç”¨ç›‘æ§

é€šè¿‡ Monkey Patch æ–¹å¼æ‹¦æˆª LiteLLM çš„ `completion` å‡½æ•°ï¼š

```python
# åœ¨ src/utils/crewai_monitor.py ä¸­
def patch_crewai_llm():
    import litellm
    original_completion = litellm.completion
    
    def monitored_completion(*args, **kwargs):
        start = time.time()
        response = original_completion(*args, **kwargs)
        end = time.time()
        # è®°å½•æ—¶é—´å’Œ token ä½¿ç”¨
        monitor.record_llm_call(...)
        return response
    
    litellm.completion = monitored_completion
```

### 2. å·¥å…·è°ƒç”¨ç›‘æ§

é€šè¿‡åŒ…è£…å™¨ä¸ºæ¯ä¸ªå·¥å…·æ·»åŠ ç›‘æ§ï¼š

```python
# åœ¨ src/main.py ä¸­
arch_read = create_monitored_tool(ReadFileTool(ROOT_DIR), "architect")
# è‡ªåŠ¨è®°å½•è¯¥å·¥å…·çš„æ¯æ¬¡è°ƒç”¨æ—¶é—´
```

### 3. Agent å’Œ Task ç›‘æ§

é€šè¿‡ Patch CrewAI çš„ Agent å’Œ Task æ‰§è¡Œæ–¹æ³•ï¼š

```python
# æ‹¦æˆª Task.execute æ–¹æ³•
def monitored_execute(self, *args, **kwargs):
    start = time.time()
    result = original_execute(self, *args, **kwargs)
    end = time.time()
    monitor.record_task(...)
    return result
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ LLM è°ƒç”¨æ¬¡æ•°æ¯”é¢„æœŸå¤šï¼Ÿ

A: CrewAI çš„ Agent åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¿›è¡Œå¤šæ¬¡"æ€è€ƒ"ï¼š
- åˆ†æä»»åŠ¡
- é€‰æ‹©å·¥å…·
- ç”Ÿæˆè¾“å‡º
- è‡ªæˆ‘åæ€å’Œä¿®æ­£

æ¯æ¬¡"æ€è€ƒ"éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ LLMã€‚

### Q2: å¦‚ä½•å‡å°‘ LLM è°ƒç”¨æ¬¡æ•°ï¼Ÿ

A: 
1. åœ¨ Agent é…ç½®ä¸­è®¾ç½® `max_iter`ï¼ˆæœ€å¤§è¿­ä»£æ¬¡æ•°ï¼‰
2. ä¼˜åŒ– prompt ä½¿ Agent æ›´å¿«åšå‡ºå†³ç­–
3. ç¦ç”¨ Agent çš„è‡ªæˆ‘åæ€åŠŸèƒ½ï¼ˆå¦‚æœ CrewAI æ”¯æŒï¼‰

### Q3: æ€§èƒ½æŠ¥å‘Šæ–‡ä»¶å¤ªå¤šæ€ä¹ˆåŠï¼Ÿ

A: å¯ä»¥å®šæœŸæ¸…ç†æ—§çš„æŠ¥å‘Šæ–‡ä»¶ï¼š

```bash
# åªä¿ç•™æœ€è¿‘ 7 å¤©çš„æŠ¥å‘Š
cd d:\AAAresearch\agent\crewai\mag-system\storage\performance_logs
# æ‰‹åŠ¨åˆ é™¤æ—§æ–‡ä»¶æˆ–ç¼–å†™æ¸…ç†è„šæœ¬
```

### Q4: å¦‚ä½•ç¦ç”¨æ€§èƒ½ç›‘æ§ï¼Ÿ

A: åœ¨ `src/main.py` ä¸­æ³¨é‡Šæ‰ç›‘æ§åˆå§‹åŒ–ä»£ç ï¼š

```python
def run_crew() -> None:
    # æ³¨é‡Šæ‰è¿™äº›è¡Œ
    # monitor = init_monitor(log_dir)
    # init_llm_callback()
    # setup_litellm_callback()
    # patch_crewai_all()
    
    # ç»§ç»­æ­£å¸¸æ‰§è¡Œ
    agents = build_agents()
    ...
```

## æ€§èƒ½ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šåˆ‡æ¢æ›´å¿«çš„æ¨¡å‹

**åœºæ™¯ï¼š** åˆ†æå‘ç° LLM è°ƒç”¨å¹³å‡è€—æ—¶ 15 ç§’ï¼Œå æ€»æ—¶é—´ 80%

**æ“ä½œï¼š** ä¿®æ”¹ `.env` æ–‡ä»¶

```bash
# åŸé…ç½®ï¼ˆæ…¢ï¼‰
OPENAI_API_BASE=https://api.deepseek.com
OPENAI_MODEL_NAME=deepseek-chat

# æ–°é…ç½®ï¼ˆå¿«ï¼‰
OPENAI_API_BASE=https://api.openai.com/v1
OPENAI_MODEL_NAME=gpt-4o-mini
```

**æ•ˆæœï¼š** LLM è°ƒç”¨å¹³å‡è€—æ—¶é™ä½åˆ° 3 ç§’ï¼Œæ€»æ—¶é—´ä» 10 åˆ†é’Ÿé™ä½åˆ° 3 åˆ†é’Ÿ

### æ¡ˆä¾‹ 2ï¼šä¼˜åŒ– RAG æ£€ç´¢

**åœºæ™¯ï¼š** åˆ†æå‘ç° RAG å·¥å…·è°ƒç”¨å  25% çš„æ—¶é—´

**æ“ä½œï¼š** åœ¨ `src/tools/rag_tools.py` ä¸­æ·»åŠ ç¼“å­˜

```python
from functools import lru_cache

class CodeRAGTool(BaseTool):
    @lru_cache(maxsize=100)
    def _run(self, query: str, top_k: int = 5) -> str:
        # æ£€ç´¢ä»£ç ...
```

**æ•ˆæœï¼š** RAG è°ƒç”¨æ—¶é—´é™ä½ 60%

## è¿›é˜¶ä½¿ç”¨

### è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡

ä½ å¯ä»¥åœ¨è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨ç›‘æ§å™¨ï¼š

```python
from src.utils import get_monitor, time_it

# æ–¹å¼ 1: ä½¿ç”¨è£…é¥°å™¨
@time_it("custom_operation", context="my_agent")
def my_function():
    # your code
    pass

# æ–¹å¼ 2: æ‰‹åŠ¨è®°å½•
monitor = get_monitor()
if monitor:
    start = monitor.start_timer()
    # do something
    end = time.time()
    monitor.record_agent_action(
        agent_name="custom",
        action_type="operation",
        start_time=start,
        end_time=end
    )
```

### å¯¼å‡ºä¸º CSV æ ¼å¼

å¦‚æœéœ€è¦ç”¨ Excel åˆ†ææ•°æ®ï¼Œå¯ä»¥è½¬æ¢ JSON æŠ¥å‘Šï¼š

```python
import json
import pandas as pd

# è¯»å–æŠ¥å‘Š
with open('storage/performance_logs/performance_report_20260206_143025.json') as f:
    data = json.load(f)

# è½¬æ¢ä¸º DataFrame
llm_df = pd.DataFrame(data['llm_calls'])
llm_df.to_csv('llm_calls.csv', index=False)

tool_df = pd.DataFrame(data['tool_calls'])
tool_df.to_csv('tool_calls.csv', index=False)
```

## æ€»ç»“

æ€§èƒ½ç›‘æ§ç³»ç»Ÿå¯ä»¥å¸®åŠ©ä½ ï¼š

1. âœ… é‡åŒ–åˆ†æç³»ç»Ÿæ€§èƒ½
2. âœ… è¯†åˆ«ä¸»è¦ç“¶é¢ˆï¼ˆLLM vs å·¥å…· vs å…¶ä»–ï¼‰
3. âœ… åšå‡ºæ•°æ®é©±åŠ¨çš„ä¼˜åŒ–å†³ç­–
4. âœ… å¯¹æ¯”ä¸åŒé…ç½®/æ¨¡å‹çš„æ€§èƒ½å·®å¼‚

å»ºè®®ï¼š**æ¯æ¬¡è¿è¡Œåéƒ½æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š**ï¼ŒæŒç»­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼
