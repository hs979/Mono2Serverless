# æ¶æ„ä¿®æ­£ï¼šDynamoDB Schema æå–ä½ç½®

## ğŸ“… ä¿®æ­£æ—¥æœŸ
2026-01-24

## ğŸ› å‘ç°çš„é—®é¢˜

### åŸè®¾è®¡çš„é”™è¯¯

åœ¨ä¹‹å‰çš„æ”¹è¿›ä¸­ï¼Œæˆ‘åœ¨ Architect Agent çš„ instructions ä¸­å†™äº†ï¼š

```yaml
**Step 1.3: Design Data Architecture**
1. Read the actual code (models.py, db initialization files) to extract:
   - Table names
   - Primary key structure
   - GSI definitions
```

**è¿™æ˜¯é”™è¯¯çš„ï¼åŸå› ï¼š**

1. **å·¥å…·æƒé™é—®é¢˜**ï¼šArchitect åªæœ‰ `ReadFileTool` å’Œ `WriteFileTool`ï¼Œè™½ç„¶å¯ä»¥è¯»æ–‡ä»¶ï¼Œä½†ä¸åº”è¯¥è¯»æºç 
2. **èŒè´£æ··ä¹±**ï¼šé™æ€åˆ†æé˜¶æ®µå·²ç»æ‰«æäº†æ‰€æœ‰ä»£ç ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ Architect å†æ‰«æä¸€éï¼Ÿ
3. **æ•ˆç‡ä½ä¸‹**ï¼šé‡å¤åŠ³åŠ¨ï¼Œä¸” Architect éœ€è¦ç†è§£å¤æ‚çš„ AST æˆ–æ­£åˆ™æå–é€»è¾‘
4. **æ¶æ„ä¸æ¸…æ™°**ï¼šé™æ€åˆ†æçš„èŒè´£å°±æ˜¯æå–ç»“æ„åŒ–ä¿¡æ¯

---

## âœ… æ­£ç¡®çš„æ¶æ„è®¾è®¡

### èŒè´£åˆ†ç¦»åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Static Analyzer        â”‚  èŒè´£ï¼šæ‰«ææºç ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
â”‚  (Preprocessing)        â”‚  
â”‚                         â”‚  - å…¥å£ç‚¹ï¼ˆAPI routesï¼‰
â”‚  - Scan source code     â”‚  - æ–‡ä»¶æ ‡ç­¾ï¼ˆDynamoDB, Auth, etc.ï¼‰
â”‚  - Extract structures   â”‚  - ä¾èµ–å…³ç³»
â”‚  - Output JSON report   â”‚  - ç¬¦å·è¡¨
â”‚                         â”‚  - **DynamoDBè¡¨ç»“æ„** â­ NEW
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ analysis_report.json
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Architect Agent        â”‚  èŒè´£ï¼šåŸºäºåˆ†ææŠ¥å‘Šè®¾è®¡æ¶æ„
â”‚                         â”‚  
â”‚  - Read report ONLY     â”‚  - è¯»å– analysis_report.json
â”‚  - Design architecture  â”‚  - è®¾è®¡ Lambda åˆ†ç»„
â”‚  - Apply best practices â”‚  - é€‰æ‹© AWS æœåŠ¡
â”‚  - Output blueprint     â”‚  - åº”ç”¨æœ€ä½³å®è·µ
â”‚                         â”‚  - è¾“å‡º blueprint.json
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å®æ–½çš„ä¿®æ­£

### 1. å¢å¼º static_analyzer.py

#### æ–°å¢å‡½æ•°ï¼š`extract_dynamodb_schemas()`

```python
def extract_dynamodb_schemas(
    monolith_root: Path, 
    file_tags: Dict[str, List[str]]
) -> List[Dict[str, Any]]:
    """
    ä»æ ‡è®°ä¸ºDynamoDBçš„æ–‡ä»¶ä¸­æå–è¡¨ç»“æ„å®šä¹‰
    
    æŸ¥æ‰¾ create_table, Table() ç­‰è°ƒç”¨ï¼Œæå–è¡¨åã€ä¸»é”®ã€GSIç­‰ä¿¡æ¯
    """
```

#### æå–ç­–ç•¥

**æ–¹æ³•1ï¼šAST è§£æ**
- æŸ¥æ‰¾ `dynamodb.create_table(...)` è°ƒç”¨
- æå–å…³é”®å­—å‚æ•°ï¼ˆTableName, KeySchema, AttributeDefinitionsï¼‰

**æ–¹æ³•2ï¼šæ­£åˆ™è¡¨è¾¾å¼**
- åŒ¹é… `TableName='Users'` æ¨¡å¼
- åœ¨ä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾é”®å®šä¹‰ï¼ˆHASH, RANGEï¼‰
- æå– GSI å®šä¹‰ï¼ˆIndexNameï¼‰

#### æå–ä¿¡æ¯

```python
{
  "name": "UsersTable",
  "partition_key": "userId",
  "partition_key_type": "S",  # String
  "sort_key": None,
  "sort_key_type": None,
  "gsi": [
    {
      "name": "EmailIndex",
      "partition_key": "email",
      "sort_key": None
    }
  ],
  "attributes": [
    {"name": "userId", "type": "S"},
    {"name": "email", "type": "S"}
  ]
}
```

#### è¾“å‡ºåˆ° analysis_report.json

```json
{
  "project_structure": "...",
  "entry_points": [...],
  "file_tags": {...},
  "dynamodb_tables": [     // â­ NEW
    {
      "name": "UsersTable",
      "partition_key": "userId",
      "partition_key_type": "S",
      "gsi": [...]
    }
  ]
}
```

---

### 2. ä¿®æ”¹ Architect Agent Instructions

#### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
```yaml
**Step 1.3: Design Data Architecture**
1. Read the actual code (models.py, db initialization files) to extract:
   - Table names
   - Primary key structure
```

#### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
```yaml
**Step 1.3: Design Data Architecture**
Read dynamodb_tables from analysis_report (extracted by static analyzer):

1. Use the pre-extracted table schemas:
   - Table names, partition keys, sort keys
   - GSI definitions
   - Attribute types
   
   Note: Static analyzer has already extracted these from code.
   You just need to read from analysis_report.dynamodb_tables.

2. Analyze access patterns and enrich the architecture:
   - High throughput â†’ Confirm on-demand billing
   - Need caching â†’ Add ElastiCache
   - Large files â†’ Store in S3
```

---

## ğŸ“Š å¯¹æ¯”ï¼šä¿®æ­£å‰å

| æ–¹é¢ | ä¿®æ­£å‰ | ä¿®æ­£å |
|------|--------|--------|
| **Schemaæå–ä½ç½®** | Architect Agent | Static Analyzer âœ… |
| **ArchitectèŒè´£** | æ‰«ææºç  + è®¾è®¡æ¶æ„ | åªè®¾è®¡æ¶æ„ âœ… |
| **æ•°æ®æ¥æº** | ç›´æ¥è¯»æºç  | è¯» analysis_report âœ… |
| **æ•ˆç‡** | é‡å¤æ‰«æï¼Œä½æ•ˆ | ä¸€æ¬¡æ‰«æï¼Œé«˜æ•ˆ âœ… |
| **æ¶æ„æ¸…æ™°åº¦** | èŒè´£æ··ä¹± | èŒè´£æ¸…æ™° âœ… |

---

## ğŸ¯ å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹ï¼ˆä¿®æ­£åï¼‰

```bash
# Step 1: é™æ€åˆ†æï¼ˆé¢„å¤„ç†ï¼‰
python src/preprocessor/static_analyzer.py --monolith-root input_monolith
# è¾“å‡º: storage/analysis_report.json
#   - entry_points
#   - file_tags
#   - dynamodb_tables â­ åŒ…å«å®Œæ•´çš„è¡¨ç»“æ„

# Step 2: æ„å»ºRAGç´¢å¼•ï¼ˆé¢„å¤„ç†ï¼‰
python src/preprocessor/build_rag.py --monolith-root input_monolith
# è¾“å‡º: storage/code_index/

# Step 3: è¿è¡ŒMulti-Agentè¿ç§»
python src/main.py
#   - Architect è¯»å– analysis_report.json
#   - ä» dynamodb_tables è·å–è¡¨ç»“æ„ â­
#   - è®¾è®¡æ¶æ„ï¼Œè¾“å‡º blueprint.json
#   - Code Developer ç”Ÿæˆä»£ç 
#   - SAM Engineer ç”Ÿæˆæ¨¡æ¿
```

---

## ğŸ“ analysis_report.json æ–°ç»“æ„

```json
{
  "project_structure": "...",
  
  "entry_points": [
    {"file": "app.py", "method": "POST", "path": "/users", "handler": "create_user"}
  ],
  
  "file_tags": {
    "app.py": ["Auth", "DynamoDB"],
    "models.py": ["DynamoDB"]
  },
  
  "dependency_graph": {...},
  
  "symbol_table": [...],
  
  "config_info": {
    "python_dependencies": [...]
  },
  
  // â­ æ–°å¢ï¼šDynamoDBè¡¨ç»“æ„
  "dynamodb_tables": [
    {
      "name": "UsersTable",
      "partition_key": "userId",
      "partition_key_type": "S",
      "sort_key": null,
      "sort_key_type": null,
      "gsi": [
        {
          "name": "EmailIndex",
          "partition_key": "email",
          "sort_key": null
        }
      ],
      "attributes": [
        {"name": "userId", "type": "S"},
        {"name": "email", "type": "S"},
        {"name": "username", "type": "S"},
        {"name": "createdAt", "type": "N"}
      ]
    },
    {
      "name": "ProductsTable",
      "partition_key": "productId",
      "partition_key_type": "S",
      ...
    }
  ]
}
```

---

## âœ… éªŒè¯æ¸…å•

### éªŒè¯ç‚¹1ï¼šé™æ€åˆ†æè¾“å‡º
- [ ] è¿è¡Œ `static_analyzer.py`
- [ ] æ£€æŸ¥ `analysis_report.json` åŒ…å« `dynamodb_tables` å­—æ®µ
- [ ] éªŒè¯è¡¨ç»“æ„ä¿¡æ¯å®Œæ•´ï¼ˆname, partition_key, gsiï¼‰

### éªŒè¯ç‚¹2ï¼šArchitectè¡Œä¸º
- [ ] Architect è¯»å– `analysis_report.json`
- [ ] Architect ä» `dynamodb_tables` è·å–è¡¨ç»“æ„
- [ ] Architect ä¸å†å°è¯•è¯»å–æºç æ–‡ä»¶
- [ ] `blueprint.json` åŒ…å«ä» report å¤åˆ¶çš„è¡¨ç»“æ„

### éªŒè¯ç‚¹3ï¼šç«¯åˆ°ç«¯æµ‹è¯•
```bash
# 1. é™æ€åˆ†æ
python src/preprocessor/static_analyzer.py --monolith-root input_monolith

# 2. æ£€æŸ¥è¾“å‡º
cat storage/analysis_report.json | grep -A 20 "dynamodb_tables"

# 3. è¿è¡Œè¿ç§»
python src/main.py

# 4. éªŒè¯blueprintåŒ…å«è¡¨ç»“æ„
cat storage/blueprint.json | grep -A 10 "dynamodb_tables"
```

---

## ğŸ“ è®¾è®¡åŸåˆ™æ€»ç»“

### åŸåˆ™1ï¼šèŒè´£å•ä¸€
æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä»¶äº‹ï¼š
- Static Analyzer â†’ æå–ä¿¡æ¯
- Architect â†’ è®¾è®¡æ¶æ„
- Code Developer â†’ ç”Ÿæˆä»£ç 
- SAM Engineer â†’ ç”Ÿæˆæ¨¡æ¿

### åŸåˆ™2ï¼šæ•°æ®æµæ¸…æ™°
```
æºç  â†’ Static Analyzer â†’ analysis_report.json
                              â†“
                         Architect â†’ blueprint.json
                              â†“
                         Agents â†’ å®Œæ•´åº”ç”¨
```

### åŸåˆ™3ï¼šé¿å…é‡å¤åŠ³åŠ¨
ä¸è¦è®©å¤šä¸ªç»„ä»¶åšåŒæ ·çš„äº‹æƒ…ï¼ˆæ‰«ææºç ã€æå–ç»“æ„ï¼‰

### åŸåˆ™4ï¼šé¢„å¤„ç†ä¼˜å…ˆ
èƒ½åœ¨é¢„å¤„ç†é˜¶æ®µåšçš„äº‹æƒ…ï¼ˆé™æ€åˆ†æï¼‰ï¼Œä¸è¦åœ¨è¿è¡Œæ—¶ï¼ˆAgentæ‰§è¡Œï¼‰åš

---

## ğŸš€ å¥½å¤„

1. **æ€§èƒ½æå‡**
   - æºç åªæ‰«æä¸€æ¬¡ï¼ˆé™æ€åˆ†æé˜¶æ®µï¼‰
   - Architect åªè¯»å– JSONï¼Œæ— éœ€è§£æä»£ç 

2. **æ¶æ„æ¸…æ™°**
   - èŒè´£åˆ†ç¦»æ˜ç¡®
   - æ•°æ®æµå‘æ¸…æ™°

3. **å¯ç»´æŠ¤æ€§**
   - Schema æå–é€»è¾‘é›†ä¸­åœ¨ä¸€å¤„ï¼ˆstatic_analyzer.pyï¼‰
   - ä¿®æ”¹æå–é€»è¾‘ä¸å½±å“ Architect

4. **å¯æ‰©å±•æ€§**
   - å®¹æ˜“æ·»åŠ æ›´å¤šçš„é™æ€åˆ†æåŠŸèƒ½
   - å®¹æ˜“æ”¯æŒå…¶ä»–æ•°æ®åº“ï¼ˆMySQL, PostgreSQLï¼‰

---

## ğŸ“š ç›¸å…³ä¿®æ”¹

- `src/preprocessor/static_analyzer.py` - æ–°å¢ `extract_dynamodb_schemas()`
- `src/config/agents.yaml` - ä¿®æ”¹ Architect instructions
- `docs/æ¶æ„ä¿®æ­£è¯´æ˜.md` - æœ¬æ–‡æ¡£

---

## âœ¨ æ€»ç»“

è¿™æ¬¡ä¿®æ­£è§£å†³äº†ä¸€ä¸ªé‡è¦çš„æ¶æ„è®¾è®¡é—®é¢˜ï¼š

**é”™è¯¯åšæ³•**ï¼šè®© Architect å»è¯»æºç æå–æ•°æ®åº“ç»“æ„
**æ­£ç¡®åšæ³•**ï¼šåœ¨é™æ€åˆ†æé˜¶æ®µæå–æ‰€æœ‰ç»“æ„åŒ–ä¿¡æ¯ï¼ŒArchitect åªè¯»å–åˆ†ææŠ¥å‘Š

è¿™æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­"èŒè´£åˆ†ç¦»"å’Œ"DRYï¼ˆDon't Repeat Yourselfï¼‰"åŸåˆ™çš„å…¸å‹åº”ç”¨ã€‚

é€šè¿‡è¿™æ¬¡ä¿®æ­£ï¼Œç³»ç»Ÿæ¶æ„æ›´åŠ æ¸…æ™°ã€é«˜æ•ˆï¼Œç¬¦åˆé¢„å¤„ç† + å†³ç­– + æ‰§è¡Œçš„ä¸‰é˜¶æ®µæ¨¡å¼ã€‚
