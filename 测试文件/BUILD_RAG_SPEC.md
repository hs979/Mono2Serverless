# build_rag.py åŠŸèƒ½è§„æ ¼è¯´æ˜

## ğŸ“… æœ€åæ›´æ–°
2026-01-27

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

ä¸ºå•ä½“åº”ç”¨ä»£ç æ„å»º **RAG å‘é‡ç´¢å¼•**ï¼Œä¾› Agent è¿›è¡Œè¯­ä¹‰ä»£ç æ£€ç´¢ã€‚

**å…³é”®è®¾è®¡åŸåˆ™**ï¼š
- âœ… **å‰ç«¯å’Œåç«¯åˆ†ç¦»å¤„ç†** - ä¸åŒçš„ç´¢å¼•ç­–ç•¥
- âœ… **é¿å…é‡å¤è§£æ** - ç›´æ¥ä½¿ç”¨ `static_analyzer.py` çš„ `symbol_table`
- âœ… **æ™ºèƒ½è¿‡æ»¤** - åªç´¢å¼•éœ€è¦ä¿®æ”¹çš„ä»£ç 

---

## ğŸ“Š ç´¢å¼•ç­–ç•¥

### ğŸ”µ å‰ç«¯æ–‡ä»¶ç­–ç•¥

**é€‚ç”¨èŒƒå›´**ï¼š
- æ–‡ä»¶æ‰©å±•åï¼š`.js`, `.ts`, `.jsx`, `.tsx`, `.vue`
- æ–‡ä»¶è·¯å¾„åŒ…å«ï¼š`frontend/`, `client/`, `ui/`, `web/`, `public/`

**å¤„ç†æµç¨‹**ï¼š
```
1. è¿‡æ»¤æ£€æŸ¥ï¼šæ˜¯å¦åŒ…å«å…³é”®ç‰¹å¾æ ‡ç­¾ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ç»§ç»­å¤„ç†
   â””â”€ å¦ â†’ âŒ è·³è¿‡ï¼ˆçº¯ UI ç»„ä»¶ï¼‰

2. ç´¢å¼•æ–¹å¼ï¼šæ•´æ–‡ä»¶ç´¢å¼•

3. Metadataï¼šæ— ï¼ˆç©ºå¯¹è±¡ {}ï¼‰
```

**å…³é”®ç‰¹å¾æ ‡ç­¾**ï¼ˆåªç´¢å¼•åŒ…å«è¿™äº›æ ‡ç­¾çš„å‰ç«¯æ–‡ä»¶ï¼‰ï¼š
```python
{
    "Frontend_API_Consumer",      # API è°ƒç”¨ï¼ˆaxios/fetch/Amplify APIï¼‰
    "Frontend_Config",             # é…ç½®æ–‡ä»¶
    "Hardcoded_URL",               # ç¡¬ç¼–ç  URL
    "Frontend_Auth_Integration"    # è®¤è¯é›†æˆé€»è¾‘
}
```

**ç¤ºä¾‹**ï¼š
```python
# frontend/src/api.jsï¼ˆæœ‰ Frontend_API_Consumer æ ‡ç­¾ï¼‰
Document(
    text="<æ•´ä¸ªæ–‡ä»¶çš„æºä»£ç >",
    metadata={}  # æ—  metadata
)

# frontend/src/components/Button.jsxï¼ˆçº¯ UI ç»„ä»¶ï¼‰
# âŒ è·³è¿‡ä¸ç´¢å¼•
```

---

### ğŸŸ¢ åç«¯æ–‡ä»¶ç­–ç•¥

**é€‚ç”¨èŒƒå›´**ï¼š
- Python æ–‡ä»¶ï¼š`.py`
- Node.js æ–‡ä»¶ï¼š`.js`, `.ts`ï¼ˆéå‰ç«¯è·¯å¾„ï¼‰

**å¤„ç†æµç¨‹**ï¼š
```
1. æ£€æŸ¥ï¼šæ–‡ä»¶åœ¨ symbol_table ä¸­æœ‰ç¬¦å·ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ æŒ‰å‡½æ•°/ç±»åˆ†ç‰‡
   â””â”€ å¦ â†’ æ•´æ–‡ä»¶ç´¢å¼•ï¼ˆä½†ä¿ç•™ metadataï¼‰

2. Metadataï¼šåŒ…å«è¯¦ç»†ä¿¡æ¯
```

**ç¬¦å·ç±»å‹**ï¼š
- Python: `function`, `class`
- Node.js: `function`, `class`, `route_handler`, `event_handler`

**Metadata ç»“æ„**ï¼š
```python
{
    "file_path": "services/database.js",
    "function_name": "getUser",
    "symbol_id": "services.database.getUser",
    "type": "function",
    "start_line": 15,
    "end_line": 30
}
```

**ç¤ºä¾‹**ï¼š

#### æƒ…å†µAï¼šæœ‰ç¬¦å·å®šä¹‰
```python
# app.js æœ‰ 3 ä¸ªè·¯ç”±å¤„ç†å™¨
Document(
    text="app.post('/register', async (req, res) => { ... })",
    metadata={
        "file_path": "app.js",
        "function_name": "POST__register",
        "symbol_id": "app.POST__register",
        "type": "route_handler",
        "start_line": 57,
        "end_line": 59
    }
)
# ... ç”Ÿæˆ 3 ä¸ªç‹¬ç«‹çš„æ–‡æ¡£
```

#### æƒ…å†µBï¼šæ— ç¬¦å·å®šä¹‰ï¼ˆé…ç½®æ–‡ä»¶ï¼‰
```python
# config/database.jsï¼ˆçº¯é…ç½®ï¼Œæ— å‡½æ•°ï¼‰
Document(
    text="<æ•´ä¸ªæ–‡ä»¶çš„æºä»£ç >",
    metadata={
        "file_path": "config/database.js",
        "function_name": "whole_file",
        "type": "file",
        "start_line": 1,
        "end_line": 25
    }
)
```

---

## ğŸ”„ å®Œæ•´å¤„ç†æµç¨‹

```
è¾“å…¥ï¼šmonolith_root + analysis_report.json
  â”‚
  â”œâ”€ ä» analysis_report æå–ï¼š
  â”‚  â”œâ”€ file_tagsï¼ˆæ–‡ä»¶æ ‡ç­¾ï¼‰
  â”‚  â””â”€ symbol_tableï¼ˆç¬¦å·è¡¨ï¼‰
  â”‚
  â”œâ”€ éå†æºä»£ç ç›®å½•
  â”‚  â”‚
  â”‚  â”œâ”€ è¿‡æ»¤æ–‡ä»¶ç±»å‹ï¼ˆ.py/.js/.ts/.jsx/.tsx/.vueï¼‰
  â”‚  â”‚
  â”‚  â”œâ”€ åˆ¤æ–­ï¼šæ˜¯å¦ä¸ºå‰ç«¯æ–‡ä»¶ï¼Ÿ
  â”‚  â”‚  â”‚
  â”‚  â”‚  â”œâ”€ æ˜¯ â†’ ã€å‰ç«¯ç­–ç•¥ã€‘
  â”‚  â”‚  â”‚     â”œâ”€ æ£€æŸ¥å…³é”®ç‰¹å¾æ ‡ç­¾
  â”‚  â”‚  â”‚     â”œâ”€ æ•´æ–‡ä»¶ç´¢å¼•
  â”‚  â”‚  â”‚     â””â”€ metadata = {}
  â”‚  â”‚  â”‚
  â”‚  â”‚  â””â”€ å¦ â†’ ã€åç«¯ç­–ç•¥ã€‘
  â”‚  â”‚        â”œâ”€ æ£€æŸ¥ symbol_table
  â”‚  â”‚        â”œâ”€ æŒ‰å‡½æ•°åˆ†ç‰‡ æˆ– æ•´æ–‡ä»¶ç´¢å¼•
  â”‚  â”‚        â””â”€ é™„å¸¦è¯¦ç»† metadata
  â”‚  â”‚
  â”‚  â””â”€ ç”Ÿæˆ Document å¯¹è±¡
  â”‚
  â””â”€ è¾“å‡ºï¼šå‘é‡ç´¢å¼•ï¼ˆä½¿ç”¨ CodeBERT embeddingï¼‰
```

---

## ğŸ“ˆ è¾“å‡ºç»Ÿè®¡ç¤ºä¾‹

```
=== Indexing Statistics ===
Total files scanned: 15

Backend files:
  - Chunked (with metadata): 8 (160 chunks)
  - Whole file (with metadata): 2

Frontend files:
  - Whole file (no metadata): 3
  - Skipped (pure UI): 5

Total documents: 165
===========================
```

**è§£é‡Š**ï¼š
- **åç«¯ 8 ä¸ªæ–‡ä»¶** â†’ æŒ‰å‡½æ•°åˆ†ç‰‡ â†’ 160 ä¸ªä»£ç ç‰‡æ®µï¼ˆæ¯ä¸ªå¸¦ metadataï¼‰
- **åç«¯ 2 ä¸ªæ–‡ä»¶** â†’ æ•´æ–‡ä»¶ç´¢å¼•ï¼ˆé…ç½®æ–‡ä»¶ï¼Œå¸¦ metadataï¼‰
- **å‰ç«¯ 3 ä¸ªæ–‡ä»¶** â†’ æ•´æ–‡ä»¶ç´¢å¼•ï¼ˆAPI/Config æ–‡ä»¶ï¼Œæ—  metadataï¼‰
- **å‰ç«¯ 5 ä¸ªæ–‡ä»¶** â†’ è·³è¿‡ï¼ˆçº¯ UI ç»„ä»¶ï¼‰
- **æ€»è®¡ 165 ä¸ªæ–‡æ¡£**

---

## ğŸ”§ æ ¸å¿ƒå‡½æ•°

### 1. `load_analysis_report()`
åŠ è½½é™æ€åˆ†æç»“æœ

### 2. `extract_code_chunk()`
ä»æºä»£ç ä¸­æå–æŒ‡å®šè¡ŒèŒƒå›´çš„ä»£ç ç‰‡æ®µ

### 3. `should_index_frontend_file()`
åˆ¤æ–­å‰ç«¯æ–‡ä»¶æ˜¯å¦éœ€è¦ç´¢å¼•ï¼ˆæ£€æŸ¥å…³é”®ç‰¹å¾æ ‡ç­¾ï¼‰

### 4. `build_documents()`
**æ ¸å¿ƒå‡½æ•°**ï¼šéå†æºä»£ç ï¼Œæ ¹æ®ç­–ç•¥æ„å»ºæ–‡æ¡£

### 5. `build_and_persist_index()`
ä½¿ç”¨ CodeBERT æ„å»ºå‘é‡ç´¢å¼•å¹¶æŒä¹…åŒ–

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### æ­¥éª¤1ï¼šè¿è¡Œé™æ€åˆ†æ
```bash
python src/preprocessor/static_analyzer.py \
  --monolith-root ./input_monolith \
  --output ./storage/analysis_report.json
```

### æ­¥éª¤2ï¼šæ„å»º RAG ç´¢å¼•
```bash
python src/preprocessor/build_rag.py \
  --monolith-root ./input_monolith \
  --index-dir ./storage/code_index \
  --analysis-report ./storage/analysis_report.json
```

### æ­¥éª¤3ï¼šæµ‹è¯•éªŒè¯
```bash
python test_build_rag.py
```

---

## âœ¨ è®¾è®¡ä¼˜åŠ¿

### 1ï¸âƒ£ æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- **å‰ç«¯**ï¼šå…³æ³¨"å“ªäº›æ–‡ä»¶éœ€è¦ä¿®æ”¹"ï¼ˆæ•´æ–‡ä»¶ç†è§£ä¸Šä¸‹æ–‡ï¼‰
- **åç«¯**ï¼šå…³æ³¨"å“ªäº›å‡½æ•°éœ€è¦ä¿®æ”¹"ï¼ˆç²¾ç¡®å®šä½ä»£ç é€»è¾‘ï¼‰

### 2ï¸âƒ£ é¿å…é‡å¤è§£æ
- é™æ€åˆ†æé˜¶æ®µï¼š`static_analyzer.py` è§£æä¸€æ¬¡ â†’ ç”Ÿæˆ `symbol_table`
- RAG æ„å»ºé˜¶æ®µï¼š`build_rag.py` ç›´æ¥ä½¿ç”¨ â†’ ä¸å†é‡å¤è§£æ

### 3ï¸âƒ£ æ™ºèƒ½è¿‡æ»¤å‡å°‘ç´¢å¼•å¤§å°
- å‰ç«¯ï¼šè·³è¿‡çº¯ UI ç»„ä»¶ï¼ˆå¯èƒ½å å‰ç«¯ä»£ç çš„ 80%ï¼‰
- åªç´¢å¼•éœ€è¦ä¿®æ”¹çš„å…³é”®æ–‡ä»¶

### 4ï¸âƒ£ Metadata ç­–ç•¥
- **å‰ç«¯æ—  metadata**ï¼šæ•´æ–‡ä»¶å†…å®¹æœ¬èº«å°±æ˜¯å®Œæ•´ä¸Šä¸‹æ–‡
- **åç«¯æœ‰ metadata**ï¼šéœ€è¦ç²¾ç¡®å®šä½åˆ°å…·ä½“å‡½æ•°å’Œè¡Œå·

---

## ğŸ” è®¾è®¡ç†ç”±

### ä¸ºä»€ä¹ˆå‰ç«¯æ•´æ–‡ä»¶ç´¢å¼•ï¼Ÿ

1. **ä¸Šä¸‹æ–‡å®Œæ•´æ€§**ï¼šå‰ç«¯æ–‡ä»¶é€šå¸¸éœ€è¦ç†è§£æ•´ä½“é€»è¾‘ï¼ˆimports, exports, ç»„ä»¶å…³ç³»ï¼‰
2. **é¿å…ç¢ç‰‡åŒ–**ï¼šAPI è°ƒç”¨ã€é…ç½®å¯¹è±¡å¯èƒ½åˆ†æ•£åœ¨æ–‡ä»¶å„å¤„
3. **ç®€åŒ–æ£€ç´¢**ï¼šAgent å¯ä»¥ä¸€æ¬¡æ€§è·å–å®Œæ•´æ–‡ä»¶å†…å®¹

### ä¸ºä»€ä¹ˆå‰ç«¯ä¸éœ€è¦ metadataï¼Ÿ

1. **æ— éœ€ç²¾ç¡®å®šä½**ï¼šå‰ç«¯ä¿®æ”¹é€šå¸¸æ˜¯æ•´ä½“æ€§çš„ï¼ˆAPI åˆ‡æ¢ã€é…ç½®æ›´æ–°ï¼‰
2. **å‡å°‘ç´¢å¼•å¤§å°**ï¼šmetadata ä¼šå¢åŠ å­˜å‚¨å¼€é”€
3. **ç®€åŒ–å¤„ç†**ï¼šAgent æ‹¿åˆ°å®Œæ•´æ–‡ä»¶å†…å®¹åè‡ªè¡Œåˆ†æå³å¯

### ä¸ºä»€ä¹ˆåç«¯æŒ‰å‡½æ•°åˆ†ç‰‡ï¼Ÿ

1. **ç²¾ç¡®å®šä½**ï¼šåç«¯é€»è¾‘å¤æ‚ï¼Œéœ€è¦å®šä½åˆ°å…·ä½“å‡½æ•°
2. **æ›´å¥½çš„æ£€ç´¢**ï¼šå‡½æ•°çº§åˆ«çš„è¯­ä¹‰æœç´¢æ›´å‡†ç¡®
3. **é™ä½å™ªéŸ³**ï¼šé¿å…æ— å…³å‡½æ•°å¹²æ‰°æ£€ç´¢ç»“æœ

### ä¸ºä»€ä¹ˆåç«¯éœ€è¦ metadataï¼Ÿ

1. **ç²¾ç¡®ä¿®æ”¹**ï¼šAgent éœ€è¦çŸ¥é“å…·ä½“ä¿®æ”¹å“ªä¸ªæ–‡ä»¶çš„å“ªä¸ªå‡½æ•°
2. **è¡Œå·å®šä½**ï¼šæ–¹ä¾¿ç”Ÿæˆ diff æˆ–ç›´æ¥ç¼–è¾‘
3. **ç¬¦å·è¿½è¸ª**ï¼š`symbol_id` æ”¯æŒè·¨æ–‡ä»¶å¼•ç”¨åˆ†æ

---

## ğŸ“Š æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  input_monolith/    â”‚ (æºä»£ç )
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â†’ static_analyzer.py
           â”‚   â””â”€â†’ analysis_report.json
           â”‚       â”œâ”€ file_tags
           â”‚       â””â”€ symbol_table
           â”‚
           â”œâ”€â†’ build_rag.py
           â”‚   â”œâ”€ å‰ç«¯ï¼šæ•´æ–‡ä»¶ç´¢å¼•ï¼ˆæ—  metadataï¼‰
           â”‚   â””â”€ åç«¯ï¼šå‡½æ•°åˆ†ç‰‡ï¼ˆæœ‰ metadataï¼‰
           â”‚
           â””â”€â†’ storage/code_index/
               â”œâ”€ docstore.json
               â”œâ”€ index_store.json
               â””â”€ vector_store.json
```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

1. âœ… ä»£ç ç‰‡æ®µæå–åŠŸèƒ½
2. âœ… å‰ç«¯æ–‡ä»¶è¿‡æ»¤ï¼ˆå…³é”®ç‰¹å¾æ ‡ç­¾ï¼‰
3. âœ… Python symbol_table è§£æ
4. âœ… Node.js symbol_table è§£æ
5. âœ… ç¬¦å·ç±»å‹åˆ†å¸ƒéªŒè¯

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `src/preprocessor/build_rag.py` - RAG ç´¢å¼•æ„å»ºï¼ˆæœ¬æ–‡ä»¶ï¼‰
- `src/preprocessor/static_analyzer.py` - é™æ€åˆ†æ
- `test_build_rag.py` - æµ‹è¯•è„šæœ¬
- `CHANGELOG_build_rag.md` - æ”¹è¿›å†å²

---

## ğŸ“Œ æ€»ç»“

`build_rag.py` å®ç°äº†ä¸€ä¸ª**æ™ºèƒ½çš„ã€åˆ†å±‚çš„**ä»£ç ç´¢å¼•ç­–ç•¥ï¼š

- âœ… **å‰ç«¯**ï¼šè¿‡æ»¤ + æ•´æ–‡ä»¶ + æ—  metadata
- âœ… **åç«¯**ï¼šå‡½æ•°åˆ†ç‰‡ + è¯¦ç»† metadata
- âœ… **ç»Ÿä¸€**ï¼šéƒ½ä½¿ç”¨ `symbol_table`ï¼Œé¿å…é‡å¤è§£æ

è¿™ç§è®¾è®¡æ—¢æ»¡è¶³äº†å‰ç«¯ä»£ç çš„æ•´ä½“æ€§éœ€æ±‚ï¼Œåˆæä¾›äº†åç«¯ä»£ç çš„ç²¾ç¡®å®šä½èƒ½åŠ›ã€‚
